<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel Dengue ‚Äî Brasil | Ernandes Sobreira</title>
  <meta name="theme-color" content="#ec4899"/>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg0:#fff7fb; --bg1:#ffe4f2; --card: rgba(255,255,255,.88);
      --stroke: rgba(120,20,80,.15); --txt:#3b0a2a; --muted: rgba(59,10,42,.68);
      --pink:#ec4899; --violet:#a855f7; --indigo:#6366f1; --teal:#14b8a6;
      --shadow: 0 18px 50px rgba(59,10,42,.12); --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 15% -5%, rgba(236,72,153,.18), transparent 60%),
        radial-gradient(1000px 560px at 95% 5%, rgba(168,85,247,.16), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    header{
      padding: 16px 18px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(255,247,251,.85);
      position: sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 210deg, var(--pink), var(--violet), var(--indigo), var(--pink));
      box-shadow: 0 14px 30px rgba(236,72,153,.18);
    }
    h1{margin:0; font-size:16px;}
    .sub{font-size:12px; color:var(--muted);}
    .status{
      font-size:12px; padding:8px 10px; border:1px solid var(--stroke);
      border-radius:999px; background: rgba(255,255,255,.6);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .dot{width:10px; height:10px; border-radius:50%; background: rgba(236,72,153,.55); box-shadow: 0 0 0 6px rgba(236,72,153,.12);}
    main{max-width:1200px; margin:14px auto 60px; padding:0 18px;}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px; align-items:start;}
    .panel{
      background: var(--card); border:1px solid var(--stroke);
      border-radius: var(--radius); box-shadow: var(--shadow); overflow:hidden;
    }
    .hd{padding:14px; border-bottom:1px solid var(--stroke); display:flex; justify-content:space-between; align-items:center;}
    .hd b{font-size:13px;}
    .tabs{display:flex; flex-wrap:wrap; gap:8px; padding:10px;}
    .tab{
      border:1px solid var(--stroke); background: rgba(255,255,255,.65);
      border-radius:999px; padding:8px 10px; font-size:12px; cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(236,72,153,.45);
      background: linear-gradient(90deg, rgba(236,72,153,.18), rgba(168,85,247,.12));
      box-shadow: 0 12px 25px rgba(236,72,153,.12);
    }
    .content{padding:12px 14px 14px;}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
    select,input{
      width:100%; padding:10px; border-radius:12px; border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end;}
    .field{flex:1 1 160px; min-width:160px;}
    .btnRow{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
    .btn{
      border:1px solid rgba(236,72,153,.35);
      background: linear-gradient(90deg, rgba(236,72,153,.18), rgba(168,85,247,.12));
      border-radius:14px; padding:10px 12px; font-weight:800; cursor:pointer;
      user-select:none;
    }
    .btn.ghost{background: rgba(255,255,255,.6); border-color: var(--stroke);}
    .mini{font-size:12px; color:var(--muted); margin-top:8px;}
    .list{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid var(--stroke); background: rgba(255,255,255,.7);
      display:flex; gap:8px; align-items:center;
    }
    .chip button{ border:none; background:transparent; cursor:pointer; font-weight:900; color:rgba(59,10,42,.7); }
    .chartWrap{padding:12px 14px 14px;}
    /* MAIS ALTO para ficar leg√≠vel */
    #chartMain{ height: 320px !important; }
    .err{
      padding:10px 14px; border-top:1px solid var(--stroke);
      background: rgba(255,255,255,.55);
      font-size:12px; color:#7a0838;
      white-space: pre-wrap; display:none;
    }
    footer{ max-width:1200px; margin: 12px auto 26px; padding: 0 18px; color: var(--muted); font-size: 12px; }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>Painel Dengue ‚Äî Brasil</h1>
      <div class="sub">Painel-Dengue feito por Ernandes Sobreira ‚Ä¢ Dados DATASUS 2025</div>
    </div>
  </div>
  <div class="status">
    <span class="dot" id="dot"></span>
    <span id="statusTxt">Iniciando‚Ä¶</span>
  </div>
</header>

<main>
  <div class="grid">
    <section class="panel">
      <div class="hd">
        <b>Controles</b>
        <button class="btn ghost" id="btnReload">‚Üª Recarregar</button>
      </div>

      <div class="tabs">
        <div class="tab active" data-view="brasil">Brasil</div>
        <div class="tab" data-view="sexo">Sexo</div>
        <div class="tab" data-view="escolaridade">Escolaridade</div>
        <div class="tab" data-view="faixa">Faixa et√°ria</div>
        <div class="tab" data-view="estados">Estados</div>
        <div class="tab" data-view="municipios">Munic√≠pios (Reg. C√°ceres)</div>
      </div>

      <div class="content">
        <div class="row" id="controlsRow"></div>
        <div id="extraArea"></div>

        <div class="btnRow">
          <button class="btn" id="btnApply">‚ú® Atualizar</button>
          <button class="btn ghost" id="btnPng">‚¨áÔ∏è Baixar gr√°fico (PNG)</button>
          <button class="btn ghost" id="btnCsv">‚¨áÔ∏è Baixar dados (CSV)</button>
        </div>
      </div>

      <div class="err" id="errBox"></div>
    </section>

    <section class="panel">
      <div class="hd">
        <b id="rightTitle">Brasil ‚Äî evolu√ß√£o</b>
        <span id="metaTxt" style="font-size:12px;color:var(--muted)">‚Äî</span>
      </div>
      <div class="chartWrap">
        <canvas id="chartMain"></canvas>
      </div>
    </section>
  </div>
</main>

<footer></footer>

<script>
const DATA_URLS = {
  brasil:       "dados-dengue.csv",
  sexo:         "dados-dengue-sexo.csv",
  escolaridade: "dados-dengue-escolaridade.csv",
  faixa:        "dados-dengue-faixa-etaria.csv",
  estados:      "dados-dengue-estados.csv",
  municipios:   "dados-dengue-municipios-regional-caceres.csv"
};
const MONTHS = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];

const state = {
  view: "brasil",
  cache: {},
  chart: null,
  currentExport: { filename:"recorte.csv", columns:[], rows:[] },
  selectedUFs: [],
  selectedMuns: []
};

function $(id){ return document.getElementById(id); }

function setStatus(ok, text){
  $("statusTxt").textContent = text;
  $("dot").style.background = ok ? "rgba(20,184,166,.55)" : "rgba(236,72,153,.55)";
  $("dot").style.boxShadow = ok ? "0 0 0 6px rgba(20,184,166,.14)" : "0 0 0 6px rgba(236,72,153,.12)";
}
function showErr(msg){ $("errBox").style.display="block"; $("errBox").textContent=msg; }
function clearErr(){ $("errBox").style.display="none"; $("errBox").textContent=""; }

function normKey(s){
  return String(s||"")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"")
    .trim();
}

// Trata "-" como NaN (buraco), n√£o como zero
function toNum(x){
  if (x===null || x===undefined) return NaN;
  const s = String(x).trim();
  if (!s || s==="-" ) return NaN;
  const n = Number(s.replace(/\./g,"").replace(",","."));
  return Number.isFinite(n) ? n : NaN;
}
function fmt(n){ return Math.round(Number(n||0)).toLocaleString("pt-BR"); }

function pickKey(sampleRow, includesList){
  const keys = Object.keys(sampleRow||{});
  for (const inc of includesList){
    const k = keys.find(x => x.includes(inc));
    if (k) return k;
  }
  return null;
}

// Remove linhas ‚Äúlixo‚Äù que v√™m do rodap√©/observa√ß√£o do Excel
function isGarbageLabel(s){
  const t = String(s||"").toLowerCase();
  return t.includes("fonte") || t.includes("minist") || t.includes("sinan") ||
         t.includes("sistema") || t.includes("inform") || t.includes("svsa") ||
         t.includes("notifica") || t.includes("agravo") || t.includes("net");
}

/* download */
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function rowsToCSV(columns, rows){
  const esc = (v)=> {
    const s = String(v ?? "");
    if (s.includes(";") || s.includes('"') || s.includes("\n")) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  return columns.map(esc).join(";") + "\n" +
    rows.map(r => columns.map(c=>esc(r[c])).join(";")).join("\n") + "\n";
}

/* ====== CSV fetch com corre√ß√£o de encoding (UTF-8 -> fallback latin1) ====== */
async function fetchCSV(url){
  const res = await fetch(url, {cache:"no-store"});
  if (!res.ok){
    throw new Error(`Falha ao baixar: ${url}\nHTTP ${res.status} ${res.statusText}\n\nüëâ Confira se o arquivo est√° na RAIZ do repo e Pages em / (root).`);
  }
  const buf = await res.arrayBuffer();

  // tenta UTF-8
  let text = new TextDecoder("utf-8", {fatal:false}).decode(buf);

  // se tiver muitos "ÔøΩ", tenta latin1
  if ((text.match(/\uFFFD/g)||[]).length >= 2){
    text = new TextDecoder("latin1", {fatal:false}).decode(buf);
  }

  const parsed = Papa.parse(text, {header:true, skipEmptyLines:true, delimiter:";"});
  const fields = parsed.meta?.fields || [];
  const headerMap = {};
  for (const f of fields) headerMap[normKey(f)] = f;

  const rows = (parsed.data||[]).map(r=>{
    const o = {};
    for (const k of Object.keys(r)) o[normKey(k)] = r[k];
    return o;
  });

  return {rows, headerMap};
}

async function getData(key){
  if (state.cache[key]) return state.cache[key];
  setStatus(false, `Carregando: ${key}‚Ä¶`);
  const pack = await fetchCSV(DATA_URLS[key]);
  state.cache[key] = pack;
  setStatus(true, `OK: ${key} (${pack.rows.length.toLocaleString("pt-BR")} linhas)`);
  return pack;
}

/* charts */
function destroyChart(){
  if (state.chart){ try{ state.chart.destroy(); } catch(e){} state.chart=null; }
}

// S√≥ pra deixar ‚Äúamplo‚Äù e leg√≠vel (n√£o achatado)
function yRangeReadable(values){
  const nums = values.filter(v=>Number.isFinite(v));
  if (!nums.length) return {min:0, max:1};
  const min = Math.min(...nums);
  const max = Math.max(...nums);
  const span = Math.max(1, max - min);

  // mais ‚Äúrespiro‚Äù
  const pad = span * 0.45;

  // se min for muito acima de 0, sobe o in√≠cio (fica ‚Äúamplo‚Äù sem parecer 0)
  if (min > 0){
    return {min: Math.max(0, min - pad), max: max + pad};
  }
  return {min: 0, max: max + pad};
}

function makeChart({type, labels, datasets, title, yValues=[], fixedY=null}){
  const ctx = $("chartMain");
  const yr = fixedY ? fixedY : yRangeReadable(yValues);

  return new Chart(ctx, {
    type,
    data:{ labels, datasets },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:"index", intersect:false},
      plugins:{
        legend:{ display:true, labels:{ usePointStyle:true, boxWidth:10, font:{size:12} } },
        title:{ display:!!title, text:title, font:{size:14} }
      },
      layout:{ padding:{ left:10, right:16, top:8, bottom:10 } },
      scales:{
        x:{
          ticks:{
            font:{ size:12 },
            maxRotation: 35,
            minRotation: 0,
            autoSkip: true
          }
        },
        y:{
          min: yr.min,
          max: yr.max,
          ticks:{
            font:{ size:12 },
            maxTicksLimit: 6,
            callback:(v)=>fmt(v)
          }
        }
      },
      elements:{ line:{ tension:0.25, borderWidth:2 }, point:{ radius:2, hoverRadius:5 } }
    }
  });
}

/* UI */
function clearControls(){ $("controlsRow").innerHTML=""; $("extraArea").innerHTML=""; }
function addField(html){
  const d=document.createElement("div");
  d.className="field";
  d.innerHTML=html;
  $("controlsRow").appendChild(d);
}
function renderChips(list, onRemove){
  const wrap = document.createElement("div");
  wrap.className="list";
  list.forEach((name, idx)=>{
    const chip=document.createElement("div");
    chip.className="chip";
    chip.innerHTML = `<span>${name}</span><button title="Remover">√ó</button>`;
    chip.querySelector("button").addEventListener("click", ()=>onRemove(idx));
    wrap.appendChild(chip);
  });
  return wrap;
}

async function buildControls(){
  clearControls();
  const v = state.view;

  if (v==="brasil"){
    const {rows:br} = await getData("brasil");
    const years = br.map(r=>String(r.ano||"").trim()).filter(Boolean);

    addField(`<label>Modo</label>
      <select id="brModo">
        <option value="anual">Anual</option>
        <option value="mensal">Mensal (por ano)</option>
      </select>`);

    addField(`<label>Ano A</label>
      <select id="brAnoA">${years.map(y=>`<option>${y}</option>`).join("")}</select>`);

    addField(`<label>Comparar?</label>
      <select id="brCompare">
        <option value="nao">N√£o</option>
        <option value="sim">Sim (Ano A vs Ano B)</option>
      </select>`);

    addField(`<label>Ano B</label>
      <select id="brAnoB">${years.map(y=>`<option>${y}</option>`).join("")}</select>`);
    return;
  }

  if (v==="sexo"){ return; }
  if (v==="faixa"){ return; }

  if (v==="escolaridade"){
    const {rows:es, headerMap} = await getData("escolaridade");
    const yearKey = pickKey(es[0], ["anonotificacao","ano"]);
    const years = es.map(r=>String(r[yearKey]||"").trim()).filter(Boolean);

    const keys = Object.keys(es[0]||{}).filter(k=>k!==yearKey && k!=="total");

    addField(`<label>Visualiza√ß√£o</label>
      <select id="escModo">
        <option value="barras">Barras (todas as classes em 1 ano)</option>
        <option value="serie">S√©rie (1 classe ao longo dos anos)</option>
      </select>`);

    addField(`<label>Ano (modo barras)</label>
      <select id="escAno">${years.map(y=>`<option>${y}</option>`).join("")}</select>`);

    addField(`<label>Classe (modo s√©rie)</label>
      <select id="escClasse">
        ${keys.map(k=>`<option value="${k}">${headerMap[k] || k}</option>`).join("")}
      </select>`);
    return;
  }

  if (v==="estados"){
    const {rows:est} = await getData("estados");
    const ufs = est.map(r=>String(r.estado||"").trim()).filter(Boolean);

    addField(`<label>Adicionar Estado</label>
      <select id="ufAdd">${ufs.map(u=>`<option>${u}</option>`).join("")}</select>`);

    const box = document.createElement("div");
    box.style.marginTop="10px";

    const btn = document.createElement("button");
    btn.className="btn ghost";
    btn.textContent="Ôºã Adicionar";
    btn.addEventListener("click", ()=>{
      const uf = $("ufAdd").value;
      if (!state.selectedUFs.includes(uf)) state.selectedUFs.push(uf);
      buildControls().then(render);
    });

    const hint = document.createElement("div");
    hint.className="mini";
    hint.textContent="Compara√ß√£o com mesmo eixo Y (para n√£o enganar a compara√ß√£o).";

    box.appendChild(btn);
    box.appendChild(hint);

    const chips = renderChips(state.selectedUFs, (i)=>{
      state.selectedUFs.splice(i,1);
      buildControls().then(render);
    });
    box.appendChild(chips);

    $("extraArea").appendChild(box);

    if (state.selectedUFs.length===0) state.selectedUFs=[ufs[0]];
    return;
  }

  if (v==="municipios"){
    const {rows:mun} = await getData("municipios");
    const munKey = pickKey(mun[0], ["municip","munic"]);
    const muns = mun.map(r=>String(r[munKey]||"").trim()).filter(Boolean).sort((a,b)=>a.localeCompare(b,'pt-BR'));

    addField(`<label>Adicionar Munic√≠pio</label>
      <select id="munAdd">${muns.map(m=>`<option>${m}</option>`).join("")}</select>`);

    const box = document.createElement("div");
    box.style.marginTop="10px";

    const btn = document.createElement("button");
    btn.className="btn ghost";
    btn.textContent="Ôºã Adicionar";
    btn.addEventListener("click", ()=>{
      const name = $("munAdd").value;
      if (!state.selectedMuns.includes(name)) state.selectedMuns.push(name);
      buildControls().then(render);
    });

    const hint = document.createElement("div");
    hint.className="mini";
    hint.textContent="Compara√ß√£o com mesmo eixo Y (Regional de C√°ceres).";

    box.appendChild(btn);
    box.appendChild(hint);

    const chips = renderChips(state.selectedMuns, (i)=>{
      state.selectedMuns.splice(i,1);
      buildControls().then(render);
    });
    box.appendChild(chips);

    $("extraArea").appendChild(box);

    if (state.selectedMuns.length===0) state.selectedMuns=[muns[0]];
    return;
  }
}

async function render(){
  clearErr();
  destroyChart();
  $("metaTxt").textContent="‚Äî";
  state.currentExport = { filename:"recorte.csv", columns:[], rows:[] };

  const v = state.view;

  if (v==="brasil"){
    const {rows:br} = await getData("brasil");
    $("rightTitle").textContent="Brasil ‚Äî dengue";

    const modo = $("brModo")?.value || "anual";

    if (modo==="anual"){
      const labels = br.map(r=>String(r.ano||"").trim()).filter(Boolean);
      const vals = br.map(r=>toNum(r.total)).map(x=>Number.isFinite(x)?x:0);

      state.chart = makeChart({
        type:"line",
        labels,
        datasets:[{label:"Total (Brasil)", data: vals}],
        title:"Evolu√ß√£o anual ‚Äî Brasil",
        yValues: vals
      });

      state.currentExport.filename="brasil_anual.csv";
      state.currentExport.columns=["Ano","Total"];
      state.currentExport.rows = labels.map((y,i)=>({Ano:y, Total: vals[i]}));
      $("metaTxt").textContent="Fonte: DATASUS (seu CSV) ‚Ä¢ Anual";
      return;
    }

    const compare = $("brCompare")?.value==="sim";
    const anoA = $("brAnoA")?.value;
    const anoB = $("brAnoB")?.value;

    function seriesForYear(ano){
      const row = br.find(r=>String(r.ano).trim()===String(ano)) || br[0];
      const arr = MONTHS.map(m=>toNum(row[normKey(m)] || row[m]));
      const missing = arr.filter(x=>!Number.isFinite(x)).length;
      return {arr, missing};
    }

    const A = seriesForYear(anoA);
    const datasets = [{label:`${anoA}`, data:A.arr.map(x=>Number.isFinite(x)?x:null)}];
    let allVals = A.arr.filter(Number.isFinite);

    let note = "";
    if (A.missing>=6) note += `‚ö† ${anoA}: meses faltando. `;

    if (compare && anoB){
      const B = seriesForYear(anoB);
      datasets.push({label:`${anoB}`, data:B.arr.map(x=>Number.isFinite(x)?x:null)});
      allVals = allVals.concat(B.arr.filter(Number.isFinite));
      if (B.missing>=6) note += `‚ö† ${anoB}: meses faltando. `;
    }

    state.chart = makeChart({
      type:"line",
      labels: MONTHS,
      datasets,
      title: compare ? `Brasil ‚Äî mensal (${anoA} vs ${anoB})` : `Brasil ‚Äî mensal (${anoA})`,
      yValues: allVals
    });

    state.currentExport.filename = compare ? `brasil_mensal_${anoA}_vs_${anoB}.csv` : `brasil_mensal_${anoA}.csv`;
    state.currentExport.columns = compare ? ["Mes", anoA, anoB] : ["Mes", anoA];
    state.currentExport.rows = MONTHS.map((m,i)=>{
      const obj = {Mes:m};
      obj[anoA] = Number.isFinite(A.arr[i]) ? A.arr[i] : "";
      if (compare) {
        const B = seriesForYear(anoB).arr;
        obj[anoB] = Number.isFinite(B[i]) ? B[i] : "";
      }
      return obj;
    });

    $("metaTxt").textContent = (note ? note : "") + "Fonte: DATASUS (seu CSV) ‚Ä¢ Mensal";
    return;
  }

  if (v==="sexo"){
    const {rows:sx, headerMap} = await getData("sexo");
    $("rightTitle").textContent="Sexo ‚Äî Brasil";

    const yearKey = pickKey(sx[0], ["anonotificacao","ano"]);
    const mascKey = pickKey(sx[0], ["mascul"]);
    const femKey  = pickKey(sx[0], ["femin"]);

    const labels = sx.map(r=>String(r[yearKey]||"").trim()).filter(Boolean);
    const masc = sx.map(r=>toNum(r[mascKey])).map(x=>Number.isFinite(x)?x:0);
    const fem  = sx.map(r=>toNum(r[femKey])).map(x=>Number.isFinite(x)?x:0);
    const all  = masc.concat(fem);

    state.chart = makeChart({
      type:"line",
      labels,
      datasets:[
        {label: headerMap[mascKey] || "Masculino", data: masc},
        {label: headerMap[femKey]  || "Feminino",  data: fem}
      ],
      title:"Casos por sexo (anual)",
      yValues: all
    });

    state.currentExport.filename="sexo_anual.csv";
    state.currentExport.columns=["Ano","Masculino","Feminino"];
    state.currentExport.rows = labels.map((y,i)=>({Ano:y, Masculino: masc[i], Feminino: fem[i]}));
    $("metaTxt").textContent="Fonte: DATASUS (seu CSV) ‚Ä¢ Anual";
    return;
  }

  if (v==="escolaridade"){
    const {rows:es, headerMap} = await getData("escolaridade");
    $("rightTitle").textContent="Escolaridade ‚Äî Brasil";

    const yearKey = pickKey(es[0], ["anonotificacao","ano"]);
    const years = es.map(r=>String(r[yearKey]||"").trim()).filter(Boolean);
    const keys = Object.keys(es[0]||{}).filter(k=>k!==yearKey && k!=="total");

    const modo = $("escModo")?.value || "barras";

    if (modo==="barras"){
      const ano = $("escAno")?.value || years[0];
      const idx = years.indexOf(ano);
      const row = es[idx] || es[0];

      const labels = keys.map(k=>headerMap[k] || k).filter(l=>!isGarbageLabel(l));
      const vals = keys
        .map(k=>({label: headerMap[k] || k, v: toNum(row[k])}))
        .filter(o=>!isGarbageLabel(o.label))
        .map(o=>Number.isFinite(o.v)?o.v:0);

      state.chart = makeChart({
        type:"bar",
        labels,
        datasets:[{label:`Total ${ano}`, data: vals}],
        title:`Escolaridade ‚Äî ${ano}`,
        yValues: vals
      });

      state.currentExport.filename=`escolaridade_${ano}.csv`;
      state.currentExport.columns=["Escolaridade","Total"];
      state.currentExport.rows = labels.map((l,i)=>({Escolaridade:l, Total: vals[i]}));
      $("metaTxt").textContent="Fonte: DATASUS (seu CSV) ‚Ä¢ Barras por classe";
      return;
    } else {
      const k = $("escClasse")?.value || keys[0];
      const labels = years;
      const vals = es.map(r=>toNum(r[k])).map(x=>Number.isFinite(x)?x:0);

      state.chart = makeChart({
        type:"line",
        labels,
        datasets:[{label: headerMap[k] || k, data: vals}],
        title:`Escolaridade ‚Äî s√©rie (${headerMap[k] || k})`,
        yValues: vals
      });

      state.currentExport.filename=`escolaridade_serie.csv`;
      state.currentExport.columns=["Ano","Total"];
      state.currentExport.rows = labels.map((y,i)=>({Ano:y, Total: vals[i]}));
      $("metaTxt").textContent="Fonte: DATASUS (seu CSV) ‚Ä¢ S√©rie anual";
      return;
    }
  }

  if (v==="faixa"){
    const {rows:fx} = await getData("faixa");
    $("rightTitle").textContent="Faixa et√°ria ‚Äî Total";

    const faixaKey = pickKey(fx[0], ["faixaetaria","faixa"]);
    const totalKey = pickKey(fx[0], ["total"]);

    const pairs = fx.map(r=>({
      faixa: String(r[faixaKey]||"").trim(),
      total: toNum(r[totalKey])
    }))
    .filter(p=>p.faixa && !isGarbageLabel(p.faixa));

    pairs.sort((a,b)=>(Number.isFinite(b.total)?b.total:0)-(Number.isFinite(a.total)?a.total:0));

    const labels = pairs.map(p=>p.faixa);
    const vals = pairs.map(p=>Number.isFinite(p.total)?p.total:0);

    state.chart = makeChart({
      type:"bar",
      labels,
      datasets:[{label:"Total", data: vals}],
      title:"Distribui√ß√£o por faixa et√°ria (total geral)",
      yValues: vals
    });

    state.currentExport.filename="faixa_etaria_total.csv";
    state.currentExport.columns=["FaixaEtaria","Total"];
    state.currentExport.rows = labels.map((l,i)=>({FaixaEtaria:l, Total: vals[i]}));
    $("metaTxt").textContent="Fonte: DATASUS (seu CSV) ‚Ä¢ Total geral";
    return;
  }

  if (v==="estados"){
    const {rows:est} = await getData("estados");
    $("rightTitle").textContent="Estados ‚Äî compara√ß√£o";

    if (!state.selectedUFs.length) { $("metaTxt").textContent="Adicione pelo menos 1 estado."; return; }

    const years = Object.keys(est[0]||{}).filter(k=>/^\d{4}$/.test(k)).sort();
    const datasets = [];
    let globalMax = 0;

    for (const uf of state.selectedUFs){
      const row = est.find(r=>String(r.estado||"").trim()===uf);
      if (!row) continue;
      const vals = years.map(y=>toNum(row[y])).map(x=>Number.isFinite(x)?x:0);
      globalMax = Math.max(globalMax, ...vals);
      datasets.push({label: uf, data: vals});
    }

    const fixedY = {min:0, max: (globalMax*1.25 || 1)}; // mais amplo
    state.chart = makeChart({
      type:"line",
      labels: years,
      datasets,
      title:"Evolu√ß√£o anual ‚Äî compara√ß√£o de estados",
      yValues:[globalMax],
      fixedY
    });

    state.currentExport.filename="estados_comparacao.csv";
    state.currentExport.columns=["Ano"].concat(state.selectedUFs);
    state.currentExport.rows = years.map((y)=>{
      const obj={Ano:y};
      for (const uf of state.selectedUFs){
        const row = est.find(r=>String(r.estado||"").trim()===uf);
        obj[uf] = row ? (Number.isFinite(toNum(row[y])) ? toNum(row[y]) : 0) : "";
      }
      return obj;
    });

    $("metaTxt").textContent="Fonte: DATASUS (seu CSV) ‚Ä¢ Mesmo eixo Y para comparar";
    return;
  }

  if (v==="municipios"){
    const {rows:mun} = await getData("municipios");
    $("rightTitle").textContent="Munic√≠pios (Reg. C√°ceres) ‚Äî compara√ß√£o";

    const munKey = pickKey(mun[0], ["municip","munic"]);
    const years = Object.keys(mun[0]||{}).filter(k=>/^\d{4}$/.test(k)).sort();

    if (!state.selectedMuns.length) { $("metaTxt").textContent="Adicione pelo menos 1 munic√≠pio."; return; }

    const datasets = [];
    let globalMax = 0;

    for (const name of state.selectedMuns){
      const row = mun.find(r=>String(r[munKey]||"").trim()===name);
      if (!row) continue;
      const vals = years.map(y=>toNum(row[y])).map(x=>Number.isFinite(x)?x:0);
      globalMax = Math.max(globalMax, ...vals);
      datasets.push({label:name, data: vals});
    }

    const fixedY = {min:0, max: (globalMax*1.25 || 1)}; // mais amplo
    state.chart = makeChart({
      type:"line",
      labels: years,
      datasets,
      title:"Evolu√ß√£o anual ‚Äî munic√≠pios (compara√ß√£o)",
      yValues:[globalMax],
      fixedY
    });

    state.currentExport.filename="municipios_regional_comparacao.csv";
    state.currentExport.columns=["Ano"].concat(state.selectedMuns);
    state.currentExport.rows = years.map((y)=>{
      const obj={Ano:y};
      for (const name of state.selectedMuns){
        const row = mun.find(r=>String(r[munKey]||"").trim()===name);
        obj[name] = row ? (Number.isFinite(toNum(row[y])) ? toNum(row[y]) : 0) : "";
      }
      return obj;
    });

    $("metaTxt").textContent="Fonte: DATASUS (seu CSV) ‚Ä¢ Mesmo eixo Y para comparar";
    return;
  }
}

/* events */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", async ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("active", x===t));
    state.view = t.dataset.view;
    try{ clearErr(); await buildControls(); await render(); }
    catch(e){ console.error(e); showErr(String(e.stack||e.message||e)); setStatus(false,"Erro."); }
  });
});

$("btnApply").addEventListener("click", async ()=>{
  try{ clearErr(); await render(); }
  catch(e){ console.error(e); showErr(String(e.stack||e.message||e)); setStatus(false,"Erro."); }
});

$("btnReload").addEventListener("click", async ()=>{
  state.cache = {};
  try{ clearErr(); await buildControls(); await render(); }
  catch(e){ console.error(e); showErr(String(e.stack||e.message||e)); setStatus(false,"Erro."); }
});

$("btnPng").addEventListener("click", ()=>{
  if (!state.chart) return alert("Sem gr√°fico para baixar.");
  const url = state.chart.toBase64Image("image/png", 1);
  const a = document.createElement("a");
  a.href = url; a.download = `grafico_${state.view}.png`;
  document.body.appendChild(a); a.click(); a.remove();
});

$("btnCsv").addEventListener("click", ()=>{
  const ex = state.currentExport;
  if (!ex || !ex.columns?.length) return alert("Sem dados para baixar.");
  downloadText(ex.filename, rowsToCSV(ex.columns, ex.rows));
});

/* start */
(async ()=>{
  try{
    clearErr();
    setStatus(false, "Carregando‚Ä¶");
    await buildControls();
    await render();
    setStatus(true, "Pronto ‚úÖ");
  }catch(e){
    console.error(e);
    showErr(String(e.stack||e.message||e));
    setStatus(false, "Erro ao iniciar.");
  }
})();
</script>
</body>
</html>
