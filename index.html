<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel Dengue ‚Äî Brasil (Leve e Sem Travar)</title>
  <meta name="theme-color" content="#ec4899"/>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg0:#fff7fb; --bg1:#ffe4f2; --card: rgba(255,255,255,.88);
      --stroke: rgba(120,20,80,.15); --txt:#3b0a2a; --muted: rgba(59,10,42,.68);
      --pink:#ec4899; --violet:#a855f7; --indigo:#6366f1; --teal:#14b8a6;
      --shadow: 0 18px 50px rgba(59,10,42,.12); --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 15% -5%, rgba(236,72,153,.18), transparent 60%),
        radial-gradient(1000px 560px at 95% 5%, rgba(168,85,247,.16), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    header{
      padding: 16px 18px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(255,247,251,.85);
      position: sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 210deg, var(--pink), var(--violet), var(--indigo), var(--pink));
      box-shadow: 0 14px 30px rgba(236,72,153,.18);
    }
    h1{margin:0; font-size:16px;}
    .sub{font-size:12px; color:var(--muted);}
    .status{
      font-size:12px; padding:8px 10px; border:1px solid var(--stroke);
      border-radius:999px; background: rgba(255,255,255,.6);
      display:flex; gap:8px; align-items:center;
    }
    .dot{width:10px; height:10px; border-radius:50%; background: rgba(236,72,153,.55); box-shadow: 0 0 0 6px rgba(236,72,153,.12);}
    main{max-width:1200px; margin:14px auto 60px; padding:0 18px;}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px; align-items:start;}
    .panel{
      background: var(--card); border:1px solid var(--stroke);
      border-radius: var(--radius); box-shadow: var(--shadow); overflow:hidden;
    }
    .hd{padding:14px; border-bottom:1px solid var(--stroke); display:flex; justify-content:space-between; align-items:center;}
    .hd b{font-size:13px;}
    .tabs{display:flex; flex-wrap:wrap; gap:8px; padding:10px;}
    .tab{
      border:1px solid var(--stroke); background: rgba(255,255,255,.65);
      border-radius:999px; padding:8px 10px; font-size:12px; cursor:pointer;
    }
    .tab.active{
      border-color: rgba(236,72,153,.45);
      background: linear-gradient(90deg, rgba(236,72,153,.18), rgba(168,85,247,.12));
      box-shadow: 0 12px 25px rgba(236,72,153,.12);
    }
    .content{padding:12px 14px 14px;}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
    select,input{
      width:100%; padding:10px; border-radius:12px; border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end;}
    .field{flex:1 1 160px; min-width:160px;}
    .btn{
      border:1px solid rgba(236,72,153,.35);
      background: linear-gradient(90deg, rgba(236,72,153,.18), rgba(168,85,247,.12));
      border-radius:14px; padding:10px 12px; font-weight:800; cursor:pointer;
    }
    .btn.ghost{background: rgba(255,255,255,.6); border-color: var(--stroke);}
    .chartWrap{padding:12px 14px 14px;}
    canvas{max-width:100%}
    .err{
      padding:10px 14px; border-top:1px solid var(--stroke);
      background: rgba(255,255,255,.55);
      font-size:12px; color: #7a0838;
      white-space: pre-wrap;
      display:none;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>Painel Dengue ‚Äî Brasil</h1>
      <div class="sub">Leve ‚Ä¢ sem travar ‚Ä¢ mostra erro na tela se faltar arquivo</div>
    </div>
  </div>
  <div class="status">
    <span class="dot" id="dot"></span>
    <span id="statusTxt">Iniciando‚Ä¶</span>
  </div>
</header>

<main>
  <div class="grid">

    <section class="panel">
      <div class="hd">
        <b>Controles</b>
        <button class="btn ghost" id="btnReload">‚Üª Recarregar</button>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-view="brasil">Brasil</div>
        <div class="tab" data-view="sexo">Sexo</div>
        <div class="tab" data-view="raca">Ra√ßa/Cor</div>
        <div class="tab" data-view="faixa">Faixa et√°ria</div>
        <div class="tab" data-view="escolaridade">Escolaridade</div>
        <div class="tab" data-view="estados">Estados</div>
        <div class="tab" data-view="municipios">Munic√≠pios (Regional C√°ceres)</div>
      </div>

      <div class="content">
        <div class="row" id="controlsRow"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn" id="btnApply">‚ú® Atualizar</button>
        </div>
      </div>

      <div class="err" id="errBox"></div>
    </section>

    <section class="panel">
      <div class="hd">
        <b id="rightTitle">Brasil ‚Äî evolu√ß√£o</b>
        <span style="font-size:12px;color:var(--muted)" id="metaTxt">‚Äî</span>
      </div>

      <div class="chartWrap">
        <canvas id="chartMain" height="140"></canvas>
      </div>
      <div class="chartWrap" style="padding-top:0">
        <canvas id="chartAlt" height="120"></canvas>
      </div>
    </section>

  </div>
</main>

<script>
/* ===== ARQUIVOS (na raiz do repo) ===== */
const DATA_URLS = {
  brasil:       "dados-dengue.csv",
  sexo:         "dados-dengue-sexo.csv",
  raca:         "dados-dengue-raca.csv",
  faixa:        "dados-dengue-faixa-etaria.csv",
  escolaridade: "dados-dengue-escolaridade.csv",
  estados:      "dados-dengue-estados.csv",
  municipios:   "dados-dengue-municipios-regional-caceres.csv"
};

const MONTHS = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];

const state = {
  view: "brasil",
  cache: {},
  chartMain: null,
  chartAlt: null,
  municipioQuery: ""
};

function $(id){ return document.getElementById(id); }

function setStatus(ok, text){
  $("statusTxt").textContent = text;
  $("dot").style.background = ok ? "rgba(20,184,166,.55)" : "rgba(236,72,153,.55)";
  $("dot").style.boxShadow = ok ? "0 0 0 6px rgba(20,184,166,.14)" : "0 0 0 6px rgba(236,72,153,.12)";
}

function showErr(msg){
  const box = $("errBox");
  box.style.display = "block";
  box.textContent = msg;
}
function clearErr(){
  const box = $("errBox");
  box.style.display = "none";
  box.textContent = "";
}

function normKey(s){
  return String(s||"")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"")
    .trim();
}
function toNum(x){
  if (x===null || x===undefined) return 0;
  const s = String(x).trim().replace(/\./g,"").replace(",",".");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function fmt(n){ return Math.round(toNum(n)).toLocaleString("pt-BR"); }

async function fetchCSV(url){
  // Aqui √© onde a m√°gica acontece: se der 404, voc√™ V√ä.
  const res = await fetch(url, {cache:"no-store"});
  if (!res.ok){
    throw new Error(`Falha ao baixar: ${url}\nHTTP ${res.status} ${res.statusText}\n\nüëâ Verifique se o arquivo est√° na RAIZ do repo e se o GitHub Pages est√° apontando para / (root).`);
  }
  const text = await res.text();
  const parsed = Papa.parse(text, {header:true, skipEmptyLines:true, delimiter:";"});
  const rows = (parsed.data||[]).map(r=>{
    const o = {};
    for (const k of Object.keys(r)) o[normKey(k)] = r[k];
    return o;
  });
  return rows;
}

async function getData(key){
  if (state.cache[key]) return state.cache[key];
  setStatus(false, `Carregando: ${key}‚Ä¶`);
  const url = DATA_URLS[key];
  const rows = await fetchCSV(url);
  state.cache[key] = rows;
  setStatus(true, `OK: ${key} (${rows.length.toLocaleString("pt-BR")} linhas)`);
  return rows;
}

function destroyCharts(){
  if (state.chartMain){ try{ state.chartMain.destroy(); }catch(e){} state.chartMain=null; }
  if (state.chartAlt){ try{ state.chartAlt.destroy(); }catch(e){} state.chartAlt=null; }
}

function lineChart(canvas, labels, datasets, title){
  return new Chart(canvas, {
    type:"line",
    data:{ labels, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:"index",intersect:false},
      plugins:{ title:{display:!!title, text:title} },
      scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>fmt(v) } } }
    }
  });
}
function barChart(canvas, labels, label, values, title){
  return new Chart(canvas, {
    type:"bar",
    data:{ labels, datasets:[{label, data:values}] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{display:!!title, text:title}, legend:{display:false} },
      scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>fmt(v) } } }
    }
  });
}

function clearControls(){ $("controlsRow").innerHTML = ""; }
function addField(html){
  const d = document.createElement("div");
  d.className = "field";
  d.innerHTML = html;
  $("controlsRow").appendChild(d);
}

async function buildControls(){
  clearControls();
  const v = state.view;

  if (v==="brasil"){
    const br = await getData("brasil");
    const years = br.map(r=>String(r.ano||"").trim()).filter(Boolean);
    addField(`<label>Modo</label>
      <select id="brModo">
        <option value="anual">Anual</option>
        <option value="mensal">Mensal (por ano)</option>
      </select>`);
    addField(`<label>Ano (mensal)</label>
      <select id="brAno">${years.map(y=>`<option>${y}</option>`).join("")}</select>`);
    return;
  }

  if (v==="sexo" || v==="raca" || v==="escolaridade"){
    const key = v;
    const rows = await getData(key);
    const years = rows.map(r=>String(r.anonotificacao||"").trim()).filter(Boolean);
    addField(`<label>Modo</label>
      <select id="modo2">
        <option value="evolucao">Evolu√ß√£o anual</option>
        <option value="barras">Compara√ß√£o (ano)</option>
      </select>`);
    addField(`<label>Ano (barras)</label>
      <select id="ano2">${years.map(y=>`<option>${y}</option>`).join("")}</select>`);
    return;
  }

  if (v==="faixa"){
    const fx = await getData("faixa");
    const labels = fx.map(r=>String(r.faixaetaria||"").trim()).filter(Boolean);
    addField(`<label>Faixa et√°ria</label>
      <select id="fxSel">${labels.map(x=>`<option>${x}</option>`).join("")}</select>`);
    return;
  }

  if (v==="estados"){
    const est = await getData("estados");
    const ufs = est.map(r=>String(r.estado||"").trim()).filter(Boolean);
    addField(`<label>Estado</label>
      <select id="ufSel">${ufs.map(u=>`<option>${u}</option>`).join("")}</select>`);
    return;
  }

  if (v==="municipios"){
    addField(`<label>Munic√≠pio (Regional de C√°ceres)</label>
      <input id="munInp" placeholder="Ex: C√°ceres / Mirassol D‚ÄôOeste / Rio Branco‚Ä¶" value="${state.municipioQuery}"/>`);
    return;
  }
}

async function render(){
  clearErr();
  destroyCharts();

  $("metaTxt").textContent = "‚Äî";

  const v = state.view;
  const cMain = $("chartMain");
  const cAlt  = $("chartAlt");

  if (v==="brasil"){
    const br = await getData("brasil");
    $("rightTitle").textContent = "Brasil ‚Äî evolu√ß√£o";

    const modo = $("brModo")?.value || "anual";
    if (modo==="anual"){
      const series = br.map(r=>({x:String(r.ano||"").trim(), y:toNum(r.total)})).filter(p=>p.x);
      state.chartMain = lineChart(cMain, series.map(p=>p.x), [{label:"Total", data:series.map(p=>p.y)}], "Brasil ‚Äî anual");
      const last = series.slice(-8);
      state.chartAlt = barChart(cAlt, last.map(p=>p.x), "Total", last.map(p=>p.y), "√öltimos anos");
      $("metaTxt").textContent = "OK";
    } else {
      const ano = $("brAno")?.value || String(br.at(-1)?.ano||"");
      const row = br.find(r=>String(r.ano).trim()===String(ano));
      const series = MONTHS.map(m=>toNum(row?.[normKey(m)] || row?.[m]));
      state.chartMain = lineChart(cMain, MONTHS, [{label:`Mensal ${ano}`, data:series}], `Brasil ‚Äî mensal (${ano})`);
      state.chartAlt  = barChart(cAlt, MONTHS, `Mensal ${ano}`, series, "Distribui√ß√£o mensal");
      $("metaTxt").textContent = "OK";
    }
    return;
  }

  if (v==="sexo"){
    const sx = await getData("sexo");
    $("rightTitle").textContent = "Sexo";
    const modo = $("modo2")?.value || "evolucao";
    const years = sx.map(r=>String(r.anonotificacao||"").trim()).filter(Boolean);
    const masc = sx.map(r=>toNum(r.masculino));
    const fem  = sx.map(r=>toNum(r.feminino));
    if (modo==="evolucao"){
      state.chartMain = lineChart(cMain, years, [
        {label:"Masculino", data:masc},
        {label:"Feminino", data:fem},
      ], "Evolu√ß√£o anual");
      const i = years.length-1;
      state.chartAlt = barChart(cAlt, ["Masculino","Feminino"], `Total ${years[i]}`, [masc[i], fem[i]], "√öltimo ano");
    } else {
      const ano = $("ano2")?.value || years.at(-1);
      const idx = years.indexOf(ano);
      state.chartMain = barChart(cMain, ["Masculino","Feminino"], `Total ${ano}`, [masc[idx], fem[idx]], "Compara√ß√£o");
      state.chartAlt  = lineChart(cAlt, years, [{label:"Total (M+F)", data: years.map((_,i)=>masc[i]+fem[i])}], "Total (M+F)");
    }
    $("metaTxt").textContent = "OK";
    return;
  }

  if (v==="raca"){
    const rc = await getData("raca");
    $("rightTitle").textContent = "Ra√ßa/Cor";
    const modo = $("modo2")?.value || "evolucao";
    const years = rc.map(r=>String(r.anonotificacao||"").trim()).filter(Boolean);
    const cols = ["branca","preta","amarela","parda","indigena"];
    const values = cols.map(c=>rc.map(r=>toNum(r[c])));
    if (modo==="evolucao"){
      state.chartMain = lineChart(cMain, years, cols.map((c,i)=>({label:c, data:values[i]})), "Evolu√ß√£o anual");
      const i = years.length-1;
      state.chartAlt  = barChart(cAlt, cols, `Total ${years[i]}`, cols.map((_,j)=>values[j][i]), "√öltimo ano");
    } else {
      const ano = $("ano2")?.value || years.at(-1);
      const idx = years.indexOf(ano);
      state.chartMain = barChart(cMain, cols, `Total ${ano}`, cols.map((_,j)=>values[j][idx]), "Compara√ß√£o");
      state.chartAlt  = lineChart(cAlt, years, [{label:"Total (soma)", data: years.map((_,i)=>cols.reduce((s,_,j)=>s+values[j][i],0))}], "Total");
    }
    $("metaTxt").textContent = "OK";
    return;
  }

  if (v==="faixa"){
    const fx = await getData("faixa");
    $("rightTitle").textContent = "Faixa et√°ria";
    const sel = $("fxSel")?.value || "";
    const row = fx.find(r=>String(r.faixaetaria||"").trim()===sel) || fx[0];
    const series = MONTHS.map(m=>toNum(row?.[normKey(m)] || row?.[m]));
    state.chartMain = lineChart(cMain, MONTHS, [{label: String(row.faixaetaria||sel||"Faixa"), data: series}], "Sazonalidade (mensal)");
    state.chartAlt  = barChart(cAlt, MONTHS, "Mensal", series, "Distribui√ß√£o mensal");
    $("metaTxt").textContent = "OK";
    return;
  }

  if (v==="escolaridade"){
    const es = await getData("escolaridade");
    $("rightTitle").textContent = "Escolaridade";
    const modo = $("modo2")?.value || "evolucao";
    const years = es.map(r=>String(r.anonotificacao||"").trim()).filter(Boolean);

    const keys = Object.keys(es[0]||{}).filter(k=>k!=="anonotificacao" && k!=="total");
    const totals = keys.map(k=>({k, t: es.reduce((s,r)=>s+toNum(r[k]),0)})).sort((a,b)=>b.t-a.t);
    const keep = totals.slice(0,6).map(x=>x.k);

    if (modo==="evolucao"){
      state.chartMain = lineChart(cMain, years, keep.map(k=>({label:k, data: es.map(r=>toNum(r[k]))})), "Top escolaridades ‚Äî evolu√ß√£o");
      const i = years.length-1;
      state.chartAlt  = barChart(cAlt, keep, `Total ${years[i]}`, keep.map(k=>toNum(es[i][k])), "√öltimo ano (Top 6)");
    } else {
      const ano = $("ano2")?.value || years.at(-1);
      const idx = years.indexOf(ano);
      const top12 = totals.map(x=>({k:x.k, v:toNum(es[idx][x.k])})).sort((a,b)=>b.v-a.v).slice(0,12);
      state.chartMain = barChart(cMain, top12.map(x=>x.k), `Total ${ano}`, top12.map(x=>x.v), "Compara√ß√£o (Top 12)");
      state.chartAlt  = lineChart(cAlt, years, top12.slice(0,2).map(x=>({label:x.k, data: es.map(r=>toNum(r[x.k]))})), "Evolu√ß√£o (Top 2)");
    }
    $("metaTxt").textContent = "OK";
    return;
  }

  if (v==="estados"){
    const est = await getData("estados");
    const uf = $("ufSel")?.value || String(est[0]?.estado||"");
    $("rightTitle").textContent = `Estado ‚Äî ${uf}`;
    const row = est.find(r=>String(r.estado||"").trim()===uf) || est[0];
    const years = Object.keys(row).filter(k=>/^\d{4}$/.test(k)).sort();
    const series = years.map(y=>toNum(row[y]));
    state.chartMain = lineChart(cMain, years, [{label:uf, data:series}], "Evolu√ß√£o anual");
    state.chartAlt  = barChart(cAlt, years.slice(-8), "Total", series.slice(-8), "√öltimos anos");
    $("metaTxt").textContent = "OK";
    return;
  }

  if (v==="municipios"){
    const m = await getData("municipios");
    $("rightTitle").textContent = "Munic√≠pios (Regional de C√°ceres)";
    const q = ($("munInp")?.value || state.municipioQuery || "").trim();
    state.municipioQuery = q;
    if (!q){
      $("metaTxt").textContent = "Digite um munic√≠pio e clique Atualizar.";
      return;
    }
    const key = "municipio"; // no CSV filtrado ficou com acento => vira "municipio"
    const qn = normKey(q);
    const row = m.find(r=>normKey(r[key]||"")===qn) || m.find(r=>normKey(r[key]||"").includes(qn));
    if (!row){
      $("metaTxt").textContent = `N√£o achei "${q}" nesse CSV (regional).`;
      return;
    }
    const years = Object.keys(row).filter(k=>/^\d{4}$/.test(k)).sort();
    const series = years.map(y=>toNum(row[y]));
    state.chartMain = lineChart(cMain, years, [{label:String(row[key]), data:series}], "Evolu√ß√£o anual");
    state.chartAlt  = barChart(cAlt, years.slice(-8), "Total", series.slice(-8), "√öltimos anos");
    $("metaTxt").textContent = "OK";
    return;
  }
}

/* ===== eventos ===== */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", async ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("active", x===t));
    state.view = t.dataset.view;
    try{
      clearErr();
      await buildControls();
      await render();
    }catch(e){
      console.error(e);
      showErr(String(e.stack||e.message||e));
      setStatus(false, "Deu erro (veja caixa de erro).");
    }
  });
});

$("btnApply").addEventListener("click", async ()=>{
  try{
    clearErr();
    await render();
  }catch(e){
    console.error(e);
    showErr(String(e.stack||e.message||e));
    setStatus(false, "Deu erro (veja caixa de erro).");
  }
});

$("btnReload").addEventListener("click", async ()=>{
  state.cache = {};
  try{
    clearErr();
    await buildControls();
    await render();
  }catch(e){
    console.error(e);
    showErr(String(e.stack||e.message||e));
    setStatus(false, "Deu erro (veja caixa de erro).");
  }
});

/* ===== start ===== */
(async ()=>{
  try{
    clearErr();
    setStatus(false, "Carregando Brasil‚Ä¶");
    await buildControls();
    await render();
    setStatus(true, "Pronto ‚úÖ");
  }catch(e){
    console.error(e);
    showErr(String(e.stack||e.message||e));
    setStatus(false, "Erro ao iniciar (veja caixa de erro).");
  }
})();
</script>
</body>
</html>
