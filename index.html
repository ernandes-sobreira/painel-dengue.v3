<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel Dengue — Brasil | Guardiãs da Saúde</title>
  <meta name="theme-color" content="#ec4899"/>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

  <style>
    :root{
      --bg0:#fff7fb;
      --bg1:#ffe4f2;
      --card: rgba(255,255,255,.86);
      --stroke: rgba(120,20,80,.15);

      --txt:#3b0a2a;
      --muted: rgba(59,10,42,.68);

      --pink:#ec4899;
      --pink2:#fb7185;
      --violet:#a855f7;
      --indigo:#6366f1;
      --teal:#14b8a6;

      --shadow: 0 18px 50px rgba(59,10,42,.12);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue";
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 15% -5%, rgba(236,72,153,.18), transparent 60%),
        radial-gradient(1000px 560px at 95% 5%, rgba(168,85,247,.16), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    header{
      padding: 18px 18px 10px;
      position: sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(255,247,251,.95), rgba(255,247,251,.75));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
    }
    .top{
      max-width: 1200px;
      margin:0 auto;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 240px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 210deg, var(--pink), var(--violet), var(--indigo), var(--pink));
      box-shadow: 0 14px 30px rgba(236,72,153,.18);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:12px;
      background: rgba(255,255,255,.35);
      transform: rotate(12deg);
    }
    h1{
      font-size: 16px; margin:0; line-height:1.1;
    }
    .sub{
      font-size: 12px; color:var(--muted); margin-top:3px;
    }
    .status{
      font-size: 12px;
      padding: 8px 10px;
      border:1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.55);
      display:flex; gap:8px; align-items:center;
      white-space: nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(236,72,153,.35);
      box-shadow: 0 0 0 6px rgba(236,72,153,.12);
    }

    main{
      max-width:1200px;
      margin: 14px auto 60px;
      padding: 0 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      align-items:start;
    }

    .panel{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.45));
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .panel .hd b{
      font-size: 13px;
      letter-spacing:.2px;
    }

    .tabs{
      display:flex; flex-wrap:wrap;
      padding: 10px;
      gap: 8px;
    }
    .tab{
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.65);
      padding: 8px 10px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; gap:8px;
    }
    .tab.active{
      border-color: rgba(236,72,153,.45);
      box-shadow: 0 12px 25px rgba(236,72,153,.12);
      background: linear-gradient(90deg, rgba(236,72,153,.18), rgba(168,85,247,.12));
    }
    .pill{
      width:10px; height:10px; border-radius:99px;
      background: rgba(236,72,153,.55);
    }

    .content{
      padding: 12px 14px 14px;
    }

    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:end;
    }
    label{
      font-size: 12px;
      color: var(--muted);
      display:block;
      margin-bottom: 6px;
    }

    .field{
      flex: 1 1 160px;
      min-width: 160px;
    }
    select, input{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.75);
      outline:none;
      font-size: 13px;
      color: var(--txt);
    }

    .btn{
      border: 1px solid rgba(236,72,153,.35);
      background: linear-gradient(90deg, rgba(236,72,153,.18), rgba(168,85,247,.12));
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 600;
      font-size: 13px;
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.ghost{
      background: rgba(255,255,255,.6);
      border-color: var(--stroke);
      font-weight: 600;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      padding: 12px 14px 14px;
      border-top: 1px solid var(--stroke);
      background: rgba(255,255,255,.35);
    }
    .kpi{
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(255,255,255,.65);
      padding: 10px 10px;
      min-height: 72px;
    }
    .kpi .t{font-size:11px; color:var(--muted)}
    .kpi .v{font-size:18px; font-weight:800; margin-top:4px}
    .kpi .s{font-size:11px; color:var(--muted); margin-top:2px}

    .chartWrap{
      padding: 12px 14px 14px;
    }
    canvas{max-width:100%}

    .qa{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--stroke);
    }
    .qa h3{
      margin:0 0 10px;
      font-size: 13px;
    }
    .cards{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .cardQ{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.65);
      border-radius: 16px;
      padding: 10px 10px;
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease;
    }
    .cardQ:active{transform: translateY(1px)}
    .cardQ .q{
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .cardQ .a{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      padding: 10px 14px 0;
    }

    .footerNote{
      max-width:1200px;
      margin: 10px auto 0;
      padding: 0 18px;
      color: var(--muted);
      font-size: 12px;
    }

    /* responsive */
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
      .status{display:none}
    }

    /* TomSelect tweaks */
    .ts-control{
      border-radius: 12px !important;
      border: 1px solid var(--stroke) !important;
      background: rgba(255,255,255,.75) !important;
      padding: 6px 8px !important;
    }
    .ts-dropdown{
      border-radius: 14px !important;
      border: 1px solid var(--stroke) !important;
      overflow:hidden;
    }
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Painel Dengue — Brasil</h1>
        <div class="sub">Estilo Guardiãs-da-Saúde • Dados DataSUS (seus CSVs)</div>
      </div>
    </div>

    <div class="status" id="statusPill">
      <span class="dot" id="dot"></span>
      <span id="statusTxt">Carregando dados…</span>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- LEFT: controls + questions -->
    <section class="panel">
      <div class="hd">
        <b>Controles</b>
        <button class="btn ghost" id="btnReload">↻ Recarregar</button>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-view="brasil"><span class="pill"></span> Brasil</div>
        <div class="tab" data-view="estados"><span class="pill"></span> Estados</div>
        <div class="tab" data-view="municipios"><span class="pill"></span> Municípios</div>
        <div class="tab" data-view="sexo"><span class="pill"></span> Sexo</div>
        <div class="tab" data-view="raca"><span class="pill"></span> Raça/Cor</div>
        <div class="tab" data-view="faixa"><span class="pill"></span> Faixa etária</div>
        <div class="tab" data-view="escolaridade"><span class="pill"></span> Escolaridade</div>
      </div>

      <div class="content">
        <div class="row" id="controlsRow">
          <!-- dynamically filled -->
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn" id="btnApply">✨ Atualizar gráficos</button>
          <button class="btn ghost" id="btnDownloadCSV">⬇️ Baixar recorte (CSV)</button>
        </div>
      </div>

      <div class="qa">
        <h3>Perguntas rápidas (clicáveis)</h3>
        <div class="cards" id="qaCards"></div>
      </div>

      <div class="hint" id="hintBox">
        Dica: municípios são mais pesados. Use a busca e evite “top 1000” no celular.
      </div>
    </section>

    <!-- RIGHT: charts + kpis -->
    <section class="panel">
      <div class="hd">
        <b id="rightTitle">Brasil — evolução</b>
        <div style="display:flex; gap:10px; align-items:center;">
          <span style="font-size:12px;color:var(--muted)" id="metaTxt">—</span>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="t">Seleção</div>
          <div class="v" id="kpiSel">—</div>
          <div class="s" id="kpiSelSub">—</div>
        </div>
        <div class="kpi">
          <div class="t">Pico</div>
          <div class="v" id="kpiPeak">—</div>
          <div class="s" id="kpiPeakSub">—</div>
        </div>
        <div class="kpi">
          <div class="t">Tendência</div>
          <div class="v" id="kpiTrend">—</div>
          <div class="s" id="kpiTrendSub">—</div>
        </div>
      </div>

      <div class="chartWrap">
        <canvas id="chartMain" height="120"></canvas>
      </div>
      <div class="chartWrap" style="padding-top:0">
        <canvas id="chartAlt" height="105"></canvas>
      </div>
    </section>

  </div>
</main>

<div class="footerNote">
  Arquivo único (index.html). Se quiser usar GitHub raw URLs, edite <b>DATA_URLS</b> no topo do script.
</div>

<script>
/* ===========================
   1) CONFIG — troque para URLs raw do GitHub se quiser
   =========================== */
const DATA_URLS = {
  brasil:        "dados-dengue.csv",
  estados:       "dados-dengue-estados.csv",
  municipios:    "dados-dengue-municipios.csv",
  sexo:          "dados-dengue-sexo.csv",
  raca:          "dados-dengue-raca.csv",
  faixa:         "dados-dengue-faixa-etaria.csv",
  escolaridade:  "dados-dengue-escolaridade.csv"
};

/* ===========================
   2) STATE
   =========================== */
const state = {
  view: "brasil",
  data: {
    brasil: null, estados: null, municipios: null, sexo: null, raca: null, faixa: null, escolaridade: null
  },
  selects: {},
  charts: { main:null, alt:null }
};

const MONTHS = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];

/* ===========================
   3) HELPERS
   =========================== */
function $(id){ return document.getElementById(id); }

function setStatus(ok, text){
  $("statusTxt").textContent = text;
  $("dot").style.background = ok ? "rgba(20,184,166,.55)" : "rgba(236,72,153,.55)";
  $("dot").style.boxShadow = ok ? "0 0 0 6px rgba(20,184,166,.14)" : "0 0 0 6px rgba(236,72,153,.12)";
}

function toNum(x){
  if (x === null || x === undefined) return 0;
  if (typeof x === "number") return Number.isFinite(x) ? x : 0;
  const s = String(x).trim().replace(/\./g,"").replace(",",".");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function fmt(n){
  const x = Math.round(toNum(n));
  return x.toLocaleString("pt-BR");
}
function pct(a,b){
  a=toNum(a); b=toNum(b);
  if (b===0) return null;
  return (a/b)*100;
}
function safeMean(arr){
  const v = arr.map(toNum).filter(n=>Number.isFinite(n));
  if (!v.length) return 0;
  return v.reduce((s,n)=>s+n,0)/v.length;
}
function trendLabel(series){
  // series: [{x:year, y:value}]
  if (!series || series.length < 6) return {label:"—", sub:"Poucos anos para comparar"};
  const last3 = series.slice(-3).map(p=>p.y);
  const prev3 = series.slice(-6,-3).map(p=>p.y);
  const m1 = safeMean(last3);
  const m0 = safeMean(prev3);
  const p = pct(m1-m0, m0);
  if (p===null) return {label:"—", sub:"Sem base de comparação"};
  const dir = (p>=0) ? "▲" : "▼";
  const txt = `${dir} ${Math.abs(p).toFixed(1)}%`;
  const sub = `Média 3 anos recentes vs. 3 anteriores`;
  return {label: txt, sub};
}
function peakOf(series){
  if (!series || !series.length) return {x:"—", y:0};
  let best = series[0];
  for (const p of series) if (toNum(p.y) > toNum(best.y)) best = p;
  return best;
}

function parseCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      delimiter: ";",
      complete: (res)=>{
        if (res.errors && res.errors.length){
          console.warn("CSV parse errors:", url, res.errors);
        }
        resolve(res.data);
      },
      error: (err)=>reject(err)
    });
  });
}

function destroyChart(ch){
  if (ch){ try{ ch.destroy(); }catch(e){} }
}

function makeLineChart(ctx, labels, datasets, title){
  return new Chart(ctx, {
    type: "line",
    data: { labels, datasets },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      interaction: { mode:"index", intersect:false },
      plugins: {
        legend: { display:true, labels:{ boxWidth:10, usePointStyle:true } },
        title: { display: !!title, text: title }
      },
      scales:{
        y: { beginAtZero:true, ticks:{ callback:(v)=> fmt(v) } }
      },
      elements:{
        line: { tension: 0.25, borderWidth: 2 },
        point:{ radius: 2, hoverRadius: 5 }
      }
    }
  });
}

function makeBarChart(ctx, labels, datasetLabel, values, title){
  return new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ label: datasetLabel, data: values, borderWidth:1 }] },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      plugins: {
        legend: { display:false },
        title: { display: !!title, text: title }
      },
      scales:{
        y: { beginAtZero:true, ticks:{ callback:(v)=> fmt(v) } }
      }
    }
  });
}

/* ===========================
   4) LOAD ALL DATA
   =========================== */
async function loadAll(){
  setStatus(false, "Carregando CSVs…");
  const keys = Object.keys(DATA_URLS);
  try{
    const [brasil, estados, municipios, sexo, raca, faixa, escolaridade] = await Promise.all([
      parseCSV(DATA_URLS.brasil),
      parseCSV(DATA_URLS.estados),
      parseCSV(DATA_URLS.municipios),
      parseCSV(DATA_URLS.sexo),
      parseCSV(DATA_URLS.raca),
      parseCSV(DATA_URLS.faixa),
      parseCSV(DATA_URLS.escolaridade)
    ]);

    state.data.brasil = brasil;
    state.data.estados = estados;
    state.data.municipios = municipios;
    state.data.sexo = sexo;
    state.data.raca = raca;
    state.data.faixa = faixa;
    state.data.escolaridade = escolaridade;

    setStatus(true, "Dados carregados ✅");
    buildControls();
    renderAll();
  }catch(err){
    console.error(err);
    setStatus(false, "Erro ao carregar. Confira nomes/URLs dos CSVs.");
    alert("Erro ao carregar CSVs. Verifique se os arquivos estão na mesma pasta do index.html ou edite DATA_URLS com URLs raw do GitHub.");
  }
}

/* ===========================
   5) UI — TABS + CONTROLS
   =========================== */
function setActiveTab(view){
  state.view = view;
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.view===view);
  });
  buildControls();
  renderAll();
}

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>setActiveTab(t.dataset.view));
});

$("btnReload").addEventListener("click", ()=>{
  loadAll();
});

$("btnApply").addEventListener("click", ()=>{
  renderAll();
});

$("btnDownloadCSV").addEventListener("click", ()=>{
  downloadCurrentSlice();
});

function clearControls(){
  $("controlsRow").innerHTML = "";
  // destroy tomselect instances
  for (const k of Object.keys(state.selects)){
    try{ state.selects[k].destroy(); }catch(e){}
  }
  state.selects = {};
}

function addField(html){
  const div = document.createElement("div");
  div.className = "field";
  div.innerHTML = html;
  $("controlsRow").appendChild(div);
}

function yearsFromBrazil(){
  // brasil CSV: Ano, Jan..Dez, Total
  return (state.data.brasil||[]).map(r=>String(r["Ano"]||"").trim()).filter(Boolean);
}
function yearsFromWide(table){
  // estados/municipios: Estado|Município + years columns
  if (!table || !table.length) return [];
  const cols = Object.keys(table[0]);
  const years = cols.filter(c=>/^\d{4}$/.test(c));
  years.sort();
  return years;
}

function buildControls(){
  clearControls();

  const view = state.view;
  const yearsBrasil = yearsFromBrazil();
  const yearsWide = yearsFromWide(state.data.estados);

  // Common year select (if needed)
  const years = (view==="brasil") ? yearsBrasil : yearsWide;

  if (view === "brasil"){
    addField(`
      <label>Modo</label>
      <select id="selBrasilModo">
        <option value="anual">Total por ano</option>
        <option value="mensal">Mensal (escolha o ano)</option>
      </select>
    `);
    addField(`
      <label>Ano (para modo mensal)</label>
      <select id="selAnoBrasil">${yearsBrasil.map(y=>`<option value="${y}">${y}</option>`).join("")}</select>
    `);
  }

  if (view === "estados"){
    addField(`
      <label>Estado</label>
      <select id="selEstado"></select>
    `);
    addField(`
      <label>Ano (ranking)</label>
      <select id="selAnoRank">${years.map(y=>`<option value="${y}">${y}</option>`).join("")}</select>
    `);
    addField(`
      <label>Top (ranking)</label>
      <select id="selTop">
        <option value="10">Top 10</option>
        <option value="20">Top 20</option>
        <option value="27">Top 27</option>
      </select>
    `);
  }

  if (view === "municipios"){
    addField(`
      <label>Município</label>
      <select id="selMunicipio"></select>
    `);
    addField(`
      <label>Observação</label>
      <input id="inpObs" value="Busca com digitação (mais leve que lista gigante)" disabled />
    `);
  }

  if (view === "sexo"){
    addField(`
      <label>Modo</label>
      <select id="selSexoModo">
        <option value="evolucao">Evolução anual</option>
        <option value="barras">Comparação (ano)</option>
      </select>
    `);
    addField(`
      <label>Ano (para barras)</label>
      <select id="selSexoAno">${years.map(y=>`<option value="${y}">${y}</option>`).join("")}</select>
    `);
  }

  if (view === "raca"){
    addField(`
      <label>Modo</label>
      <select id="selRacaModo">
        <option value="evolucao">Evolução anual</option>
        <option value="barras">Comparação (ano)</option>
      </select>
    `);
    addField(`
      <label>Ano (para barras)</label>
      <select id="selRacaAno">${years.map(y=>`<option value="${y}">${y}</option>`).join("")}</select>
    `);
  }

  if (view === "faixa"){
    addField(`
      <label>Modo</label>
      <select id="selFaixaModo">
        <option value="total">Total por faixa (ano mensal agregado)</option>
        <option value="mensal">Mensal (escolha ano e faixa)</option>
      </select>
    `);
    addField(`
      <label>Ano (para mensal)</label>
      <select id="selFaixaAno">${yearsBrasil.map(y=>`<option value="${y}">${y}</option>`).join("")}</select>
    `);
    addField(`
      <label>Faixa etária (para mensal)</label>
      <select id="selFaixa"></select>
    `);
  }

  if (view === "escolaridade"){
    addField(`
      <label>Modo</label>
      <select id="selEscModo">
        <option value="evolucao">Evolução anual</option>
        <option value="barras">Comparação (ano)</option>
      </select>
    `);
    addField(`
      <label>Ano (para barras)</label>
      <select id="selEscAno">${years.map(y=>`<option value="${y}">${y}</option>`).join("")}</select>
    `);
  }

  // fill options for state/municipio/faixa
  if (view === "estados"){
    const est = (state.data.estados||[]).map(r=>String(r["Estado"]||"").trim()).filter(Boolean);
    const sel = document.getElementById("selEstado");
    sel.innerHTML = est.map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
    state.selects.estado = new TomSelect("#selEstado", { create:false, sortField:{field:"text", direction:"asc"} });
    state.selects.estado.setValue(est[0] || "");
  }

  if (view === "municipios"){
    const mun = (state.data.municipios||[]).map(r=>String(r["Município"]||r["Municipio"]||"").trim()).filter(Boolean);
    const sel = document.getElementById("selMunicipio");
    sel.innerHTML = mun.map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
    state.selects.municipio = new TomSelect("#selMunicipio", {
      create:false,
      maxOptions: 150,
      sortField:{field:"text", direction:"asc"}
    });
    state.selects.municipio.setValue(mun[0] || "");
  }

  if (view === "faixa"){
    const fx = (state.data.faixa||[]).map(r=>String(r["Faixa Etária"]||"").trim()).filter(Boolean);
    const sel = document.getElementById("selFaixa");
    sel.innerHTML = fx.map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
    state.selects.faixa = new TomSelect("#selFaixa", { create:false, sortField:{field:"text", direction:"asc"} });
    state.selects.faixa.setValue(fx[0] || "");
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

/* ===========================
   6) DATA EXTRACTORS
   =========================== */
function seriesBrasilAnual(){
  const rows = state.data.brasil || [];
  return rows.map(r=>({ x: String(r["Ano"]).trim(), y: toNum(r["Total"]) }));
}
function seriesBrasilMensal(ano){
  const row = (state.data.brasil||[]).find(r=>String(r["Ano"]).trim()===String(ano));
  if (!row) return MONTHS.map(m=>({x:m,y:0}));
  return MONTHS.map(m=>({ x:m, y: toNum(row[m]) }));
}

function wideRowByKey(table, keyName, keyValue){
  return (table||[]).find(r=>String(r[keyName]||"").trim().toLowerCase() === String(keyValue||"").trim().toLowerCase());
}
function seriesFromWideRow(row){
  if (!row) return [];
  const years = Object.keys(row).filter(c=>/^\d{4}$/.test(c)).sort();
  return years.map(y=>({ x:y, y: toNum(row[y]) }));
}

function topFromWide(table, year, topN, keyName){
  const arr = (table||[])
    .map(r=>({ k: String(r[keyName]||"").trim(), v: toNum(r[year]) }))
    .filter(x=>x.k && Number.isFinite(x.v))
    .sort((a,b)=>b.v-a.v)
    .slice(0, topN);
  return arr;
}

function seriesSexo(){
  // columns: Ano notificação; Ignorado; Masculino; Feminino; Total
  const rows = state.data.sexo || [];
  const years = rows.map(r=>String(r["Ano notificação"]||r["Ano notificacao"]||"").trim());
  const ign = rows.map(r=>toNum(r["Ignorado"]));
  const masc = rows.map(r=>toNum(r["Masculino"]));
  const fem = rows.map(r=>toNum(r["Feminino"]));
  return { years, ign, masc, fem };
}

function seriesRaca(){
  const rows = state.data.raca || [];
  const years = rows.map(r=>String(r["Ano notificação"]||r["Ano notificacao"]||"").trim());
  const cols = ["Branca","Preta","Amarela","Parda","Indigena"];
  const values = {};
  cols.forEach(c=> values[c] = rows.map(r=>toNum(r[c])) );
  return { years, cols, values };
}

function seriesEscolaridade(){
  const rows = state.data.escolaridade || [];
  const years = rows.map(r=>String(r["Ano notificação"]||r["Ano notificacao"]||"").trim());
  const cols = Object.keys(rows[0]||{}).filter(c=>!["Ano notificação","Ano notificacao","Total"].includes(c));
  const values = {};
  cols.forEach(c=> values[c] = rows.map(r=>toNum(r[c])) );
  return { years, cols, values };
}

/* ===========================
   7) RENDER
   =========================== */
function renderAll(){
  renderCharts();
  renderKPIs();
  renderQA();
}

function renderCharts(){
  const view = state.view;

  destroyChart(state.charts.main);
  destroyChart(state.charts.alt);

  const ctxMain = $("chartMain");
  const ctxAlt  = $("chartAlt");

  // clear canvases by resetting height (cheap trick)
  ctxMain.height = 120;
  ctxAlt.height = 105;

  if (view==="brasil"){
    $("rightTitle").textContent = "Brasil — dengue";
    const modo = $("selBrasilModo")?.value || "anual";
    const ano = $("selAnoBrasil")?.value || yearsFromBrazil().slice(-1)[0];

    if (modo==="anual"){
      const s = seriesBrasilAnual();
      const labels = s.map(p=>p.x);
      const vals = s.map(p=>p.y);

      state.charts.main = makeLineChart(ctxMain, labels, [{
        label:"Brasil (Total)",
        data: vals,
        borderColor: "rgba(236,72,153,.9)",
        backgroundColor: "rgba(236,72,153,.18)"
      }], "Evolução anual");

      // alt: barras com últimos 8 anos
      const last = s.slice(-8);
      state.charts.alt = makeBarChart(ctxAlt, last.map(p=>p.x), "Total", last.map(p=>p.y), "Últimos anos (visão rápida)");
      $("metaTxt").textContent = `Fonte: seus CSVs • visão: anual`;
    } else {
      const s = seriesBrasilMensal(ano);
      state.charts.main = makeLineChart(ctxMain, s.map(p=>p.x), [{
        label:`Brasil (Mensal ${ano})`,
        data: s.map(p=>p.y),
        borderColor: "rgba(168,85,247,.9)",
        backgroundColor: "rgba(168,85,247,.16)"
      }], `Sazonalidade (mensal) — ${ano}`);

      // alt: barras do mesmo ano
      state.charts.alt = makeBarChart(ctxAlt, s.map(p=>p.x), `Mensal ${ano}`, s.map(p=>p.y), "Distribuição mensal");
      $("metaTxt").textContent = `Fonte: seus CSVs • visão: mensal`;
    }
    return;
  }

  if (view==="estados"){
    const uf = $("selEstado")?.value || "";
    $("rightTitle").textContent = `Estado — ${uf}`;
    const row = wideRowByKey(state.data.estados, "Estado", uf);
    const s = seriesFromWideRow(row);

    state.charts.main = makeLineChart(ctxMain, s.map(p=>p.x), [{
      label: uf,
      data: s.map(p=>p.y),
      borderColor: "rgba(236,72,153,.9)",
      backgroundColor: "rgba(236,72,153,.18)"
    }], "Evolução anual (Estado)");

    const year = $("selAnoRank")?.value || s.slice(-1)[0]?.x;
    const topN = parseInt($("selTop")?.value || "10", 10);
    const top = topFromWide(state.data.estados, year, topN, "Estado");
    state.charts.alt = makeBarChart(ctxAlt, top.map(x=>x.k), `Total (${year})`, top.map(x=>x.v), `Ranking — Top ${topN} (${year})`);

    $("metaTxt").textContent = `Ranking e série histórica por estado`;
    return;
  }

  if (view==="municipios"){
    const mun = $("selMunicipio")?.value || "";
    $("rightTitle").textContent = `Município — ${mun}`;
    const key = (state.data.municipios?.[0]?.["Município"] !== undefined) ? "Município" : "Municipio";
    const row = wideRowByKey(state.data.municipios, key, mun);
    const s = seriesFromWideRow(row);

    state.charts.main = makeLineChart(ctxMain, s.map(p=>p.x), [{
      label: mun,
      data: s.map(p=>p.y),
      borderColor: "rgba(168,85,247,.9)",
      backgroundColor: "rgba(168,85,247,.16)"
    }], "Evolução anual (Município)");

    // alt: últimos 10 anos
    const last = s.slice(-10);
    state.charts.alt = makeBarChart(ctxAlt, last.map(p=>p.x), "Total", last.map(p=>p.y), "Últimos 10 anos");
    $("metaTxt").textContent = `Busca por município (mais pesado)`;
    return;
  }

  if (view==="sexo"){
    $("rightTitle").textContent = "Sexo — comparações";
    const modo = $("selSexoModo")?.value || "evolucao";
    const { years, ign, masc, fem } = seriesSexo();

    if (modo==="evolucao"){
      state.charts.main = makeLineChart(ctxMain, years, [
        { label:"Masculino", data: masc, borderColor:"rgba(236,72,153,.9)", backgroundColor:"rgba(236,72,153,.12)" },
        { label:"Feminino",  data: fem,  borderColor:"rgba(99,102,241,.9)", backgroundColor:"rgba(99,102,241,.12)" },
        { label:"Ignorado",  data: ign,  borderColor:"rgba(20,184,166,.9)", backgroundColor:"rgba(20,184,166,.10)" }
      ], "Evolução anual por sexo");

      // alt: último ano em barras
      const i = years.length-1;
      state.charts.alt = makeBarChart(ctxAlt, ["Masculino","Feminino","Ignorado"], `Total (${years[i]})`, [masc[i], fem[i], ign[i]], "Último ano (comparação)");
      $("metaTxt").textContent = "Evolução anual + comparação";
    } else {
      const ano = $("selSexoAno")?.value || years[years.length-1];
      const idx = years.indexOf(ano);
      state.charts.main = makeBarChart(ctxMain, ["Masculino","Feminino","Ignorado"], `Total (${ano})`, [masc[idx], fem[idx], ign[idx]], `Comparação por sexo — ${ano}`);
      // alt: evolução total (masc+fem)
      const totalMF = masc.map((v,i)=>toNum(v)+toNum(fem[i]));
      state.charts.alt = makeLineChart(ctxAlt, years, [{ label:"Masculino+Feminino", data: totalMF, borderColor:"rgba(168,85,247,.9)", backgroundColor:"rgba(168,85,247,.12)" }], "Evolução (M+F)");
      $("metaTxt").textContent = "Comparação por ano selecionado";
    }
    return;
  }

  if (view==="raca"){
    $("rightTitle").textContent = "Raça/Cor — comparações";
    const modo = $("selRacaModo")?.value || "evolucao";
    const { years, cols, values } = seriesRaca();

    if (modo==="evolucao"){
      const ds = cols.map((c, idx)=>({
        label: c,
        data: values[c],
        borderColor: "rgba(236,72,153,.9)",
        backgroundColor:"rgba(236,72,153,.08)"
      }));
      // para não ficar tudo igual, alterna “cor base” sem precisar escolher paleta manual
      ds.forEach((d,i)=>{
        const pick = ["rgba(236,72,153,.9)","rgba(168,85,247,.9)","rgba(99,102,241,.9)","rgba(20,184,166,.9)","rgba(251,113,133,.9)"][i%5];
        d.borderColor = pick;
        d.backgroundColor = pick.replace(".9",".10");
      });

      state.charts.main = makeLineChart(ctxMain, years, ds, "Evolução anual por raça/cor");

      const i = years.length-1;
      state.charts.alt = makeBarChart(ctxAlt, cols, `Total (${years[i]})`, cols.map(c=>values[c][i]), "Último ano (comparação)");
      $("metaTxt").textContent = "Evolução + comparação (último ano)";
    } else {
      const ano = $("selRacaAno")?.value || years[years.length-1];
      const idx = years.indexOf(ano);
      state.charts.main = makeBarChart(ctxMain, cols, `Total (${ano})`, cols.map(c=>values[c][idx]), `Comparação — ${ano}`);
      // alt: total
      const total = years.map((_,i)=>cols.reduce((s,c)=>s+toNum(values[c][i]),0));
      state.charts.alt = makeLineChart(ctxAlt, years, [{ label:"Total (soma)", data: total, borderColor:"rgba(236,72,153,.9)", backgroundColor:"rgba(236,72,153,.10)" }], "Total (soma das categorias)");
      $("metaTxt").textContent = "Comparação por ano selecionado";
    }
    return;
  }

  if (view==="faixa"){
    $("rightTitle").textContent = "Faixa etária — leitura rápida";
    const modo = $("selFaixaModo")?.value || "total";

    if (modo==="total"){
      // usa "Total" de cada faixa (linha)
      const rows = state.data.faixa || [];
      const labels = rows.ma
