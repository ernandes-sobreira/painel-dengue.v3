<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel Dengue ‚Äî Brasil | Guardi√£s da Sa√∫de (Leve)</title>
  <meta name="theme-color" content="#ec4899"/>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#fff7fb;
      --bg1:#ffe4f2;
      --card: rgba(255,255,255,.86);
      --stroke: rgba(120,20,80,.15);
      --txt:#3b0a2a;
      --muted: rgba(59,10,42,.68);
      --pink:#ec4899;
      --violet:#a855f7;
      --indigo:#6366f1;
      --teal:#14b8a6;
      --shadow: 0 18px 50px rgba(59,10,42,.12);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 15% -5%, rgba(236,72,153,.18), transparent 60%),
        radial-gradient(1000px 560px at 95% 5%, rgba(168,85,247,.16), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    header{
      padding: 18px 18px 10px;
      position: sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(255,247,251,.95), rgba(255,247,251,.75));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
    }
    .top{
      max-width: 1200px; margin:0 auto;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 210deg, var(--pink), var(--violet), var(--indigo), var(--pink));
      box-shadow: 0 14px 30px rgba(236,72,153,.18);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:""; position:absolute; inset:10px; border-radius:12px;
      background: rgba(255,255,255,.35); transform: rotate(12deg);
    }
    h1{font-size: 16px; margin:0; line-height:1.1;}
    .sub{font-size: 12px; color:var(--muted); margin-top:3px;}
    .status{
      font-size: 12px;
      padding: 8px 10px;
      border:1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.55);
      display:flex; gap:8px; align-items:center;
      white-space: nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(236,72,153,.55);
      box-shadow: 0 0 0 6px rgba(236,72,153,.12);
    }
    main{max-width:1200px; margin:14px auto 60px; padding:0 18px;}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px; align-items:start;}
    .panel{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding: 14px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.45));
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .hd b{font-size:13px;}
    .tabs{display:flex; flex-wrap:wrap; padding:10px; gap:8px;}
    .tab{
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.65);
      padding: 8px 10px;
      font-size: 12px;
      cursor:pointer; user-select:none;
      display:flex; align-items:center; gap:8px;
    }
    .tab.active{
      border-color: rgba(236,72,153,.45);
      box-shadow: 0 12px 25px rgba(236,72,153,.12);
      background: linear-gradient(90deg, rgba(236,72,153,.18), rgba(168,85,247,.12));
    }
    .pill{width:10px; height:10px; border-radius:99px; background: rgba(236,72,153,.55);}
    .content{padding: 12px 14px 14px;}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.75);
      outline:none; font-size:13px; color:var(--txt);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end;}
    .field{flex:1 1 160px; min-width:160px;}
    .btn{
      border:1px solid rgba(236,72,153,.35);
      background: linear-gradient(90deg, rgba(236,72,153,.18), rgba(168,85,247,.12));
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn.ghost{background: rgba(255,255,255,.6); border-color: var(--stroke);}
    .btn:active{transform: translateY(1px)}
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      padding: 12px 14px 14px;
      border-top: 1px solid var(--stroke);
      background: rgba(255,255,255,.35);
    }
    .kpi{
      border:1px solid var(--stroke);
      border-radius:16px;
      background: rgba(255,255,255,.65);
      padding:10px;
      min-height:72px;
    }
    .kpi .t{font-size:11px; color:var(--muted)}
    .kpi .v{font-size:18px; font-weight:900; margin-top:4px}
    .kpi .s{font-size:11px; color:var(--muted); margin-top:2px}
    .chartWrap{padding:12px 14px 14px;}
    canvas{max-width:100%}
    .qa{padding:12px 14px 14px; border-top:1px solid var(--stroke);}
    .qa h3{margin:0 0 10px; font-size:13px;}
    .cardQ{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.65);
      border-radius: 16px;
      padding: 10px;
      margin-bottom:10px;
      user-select:none;
    }
    .cardQ .q{font-size:12px; font-weight:900; margin-bottom:6px;}
    .cardQ .a{font-size:12px; color:var(--muted); line-height:1.35;}
    .hint{font-size:12px; color:var(--muted); padding:10px 14px 0;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Painel Dengue ‚Äî Brasil</h1>
        <div class="sub">Vers√£o leve (lazy-load) ‚Ä¢ Estilo Guardi√£s-da-Sa√∫de</div>
      </div>
    </div>
    <div class="status">
      <span class="dot" id="dot"></span>
      <span id="statusTxt">Iniciando‚Ä¶</span>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <section class="panel">
      <div class="hd">
        <b>Controles</b>
        <button class="btn ghost" id="btnReload">‚Üª Recarregar</button>
      </div>

      <div class="tabs">
        <div class="tab active" data-view="brasil"><span class="pill"></span> Brasil</div>
        <div class="tab" data-view="estados"><span class="pill"></span> Estados</div>
        <div class="tab" data-view="municipios"><span class="pill"></span> Munic√≠pios</div>
        <div class="tab" data-view="sexo"><span class="pill"></span> Sexo</div>
        <div class="tab" data-view="raca"><span class="pill"></span> Ra√ßa/Cor</div>
        <div class="tab" data-view="faixa"><span class="pill"></span> Faixa et√°ria</div>
        <div class="tab" data-view="escolaridade"><span class="pill"></span> Escolaridade</div>
      </div>

      <div class="content">
        <div class="row" id="controlsRow"></div>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn" id="btnApply">‚ú® Atualizar</button>
          <button class="btn ghost" id="btnDownload">‚¨áÔ∏è Baixar recorte</button>
        </div>
      </div>

      <div class="qa">
        <h3>Perguntas r√°pidas</h3>
        <div id="qaCards"></div>
      </div>

      <div class="hint" id="hintBox">
        Leve: carrega por aba. Munic√≠pios: digite e clique ‚ÄúBuscar‚Äù.
      </div>
    </section>

    <section class="panel">
      <div class="hd">
        <b id="rightTitle">Brasil ‚Äî evolu√ß√£o</b>
        <span style="font-size:12px;color:var(--muted)" id="metaTxt">‚Äî</span>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="t">Sele√ß√£o</div>
          <div class="v" id="kpiSel">‚Äî</div>
          <div class="s" id="kpiSelSub">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="t">Pico</div>
          <div class="v" id="kpiPeak">‚Äî</div>
          <div class="s" id="kpiPeakSub">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="t">Tend√™ncia</div>
          <div class="v" id="kpiTrend">‚Äî</div>
          <div class="s" id="kpiTrendSub">‚Äî</div>
        </div>
      </div>

      <div class="chartWrap">
        <canvas id="chartMain" height="120"></canvas>
      </div>
      <div class="chartWrap" style="padding-top:0">
        <canvas id="chartAlt" height="105"></canvas>
      </div>
    </section>

  </div>
</main>

<script>
/* =========================
   1) ARQUIVOS (na raiz)
   ========================= */
// Munic√≠pios: TROQUE para o arquivo leve da Regional de C√°ceres:
const DATA_URLS = {
  brasil:        "dados-dengue.csv",
  estados:       "dados-dengue-estados.csv",
  municipios:    "dados-dengue-municipios-regional-caceres.csv", // ‚úÖ leve
  sexo:          "dados-dengue-sexo.csv",
  raca:          "dados-dengue-raca.csv",
  faixa:         "dados-dengue-faixa-etaria.csv",
  escolaridade:  "dados-dengue-escolaridade.csv",
};

/* =========================
   2) estado
   ========================= */
const state = {
  view: "brasil",
  cache: {},
  charts: { main:null, alt:null },
  selection: { municipio:null }
};

const MONTHS = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];

function $(id){ return document.getElementById(id); }

function setStatus(ok, text){
  $("statusTxt").textContent = text;
  $("dot").style.background = ok ? "rgba(20,184,166,.55)" : "rgba(236,72,153,.55)";
  $("dot").style.boxShadow = ok ? "0 0 0 6px rgba(20,184,166,.14)" : "0 0 0 6px rgba(236,72,153,.12)";
}

function normKey(s){
  return String(s||"")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"")
    .trim();
}

function toNum(x){
  if (x===null || x===undefined) return 0;
  if (typeof x==="number") return Number.isFinite(x) ? x : 0;
  const s = String(x).trim().replace(/\./g,"").replace(",",".");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function fmt(n){ return Math.round(toNum(n)).toLocaleString("pt-BR"); }

function normalizeRows(rows){
  const out = [];
  for (const r of (rows||[])){
    const obj = {};
    for (const k of Object.keys(r)){
      obj[normKey(k)] = r[k];
    }
    out.push(obj);
  }
  return out;
}

function destroyChart(ch){ if (ch){ try{ ch.destroy(); } catch(e){} } }

function makeLineChart(canvas, labels, datasets, title){
  return new Chart(canvas, {
    type:"line",
    data:{ labels, datasets },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{ mode:"index", intersect:false },
      plugins:{
        legend:{ display:true, labels:{ boxWidth:10, usePointStyle:true } },
        title:{ display:!!title, text:title }
      },
      scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>fmt(v) } } },
      elements:{ line:{ tension:0.25, borderWidth:2 }, point:{ radius:2, hoverRadius:5 } }
    }
  });
}

function makeBarChart(canvas, labels, label, values, title){
  return new Chart(canvas, {
    type:"bar",
    data:{ labels, datasets:[{ label, data: values, borderWidth:1 }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{display:false}, title:{display:!!title, text:title} },
      scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>fmt(v) } } }
    }
  });
}

function peak(series){
  if (!series.length) return {x:"‚Äî", y:0};
  return series.reduce((a,b)=> (toNum(b.y) > toNum(a.y)) ? b : a);
}

function trend(series){
  if (series.length < 6) return {label:"‚Äî", sub:"Poucos anos"};
  const last3 = series.slice(-3).map(p=>toNum(p.y));
  const prev3 = series.slice(-6,-3).map(p=>toNum(p.y));
  const m1 = last3.reduce((s,n)=>s+n,0)/3;
  const m0 = prev3.reduce((s,n)=>s+n,0)/3;
  if (m0 === 0) return {label:"‚Äî", sub:"Base anterior zerada"};
  const p = ((m1-m0)/m0)*100;
  const dir = p>=0 ? "‚ñ≤" : "‚ñº";
  return {label:`${dir} ${Math.abs(p).toFixed(1)}%`, sub:"M√©dia 3 anos vs 3 anteriores"};
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

function addQA(q,a){
  const div = document.createElement("div");
  div.className = "cardQ";
  div.innerHTML = `<div class="q">‚ùì ${escapeHtml(q)}</div><div class="a">${escapeHtml(a)}</div>`;
  $("qaCards").appendChild(div);
}

/* =========================
   3) carrega CSV (worker)
   ========================= */
function parseCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url, {
      download:true,
      header:true,
      skipEmptyLines:true,
      delimiter:";",
      worker:true,
      complete:(res)=> resolve(normalizeRows(res.data)),
      error:(err)=> reject(err)
    });
  });
}

async function getData(key){
  if (state.cache[key]) return state.cache[key];
  setStatus(false, `Carregando: ${key}‚Ä¶`);
  const rows = await parseCSV(DATA_URLS[key]);
  state.cache[key] = rows;
  setStatus(true, `OK: ${key} (${rows.length.toLocaleString("pt-BR")} linhas)`);
  return rows;
}

/* =========================
   4) Controles por aba
   ========================= */
function clearControls(){ $("controlsRow").innerHTML = ""; }
function addField(html){
  const div = document.createElement("div");
  div.className = "field";
  div.innerHTML = html;
  $("controlsRow").appendChild(div);
}

async function buildControls(){
  clearControls();
  const v = state.view;

  if (v==="brasil"){
    const brasil = await getData("brasil");
    const years = brasil.map(r=>String(r.ano||"").trim()).filter(Boolean);

    addField(`<label>Modo</label>
      <select id="selBrasilModo">
        <option value="anual">Total por ano</option>
        <option value="mensal">Mensal (escolha o ano)</option>
      </select>`);

    addField(`<label>Ano (modo mensal)</label>
      <select id="selAnoBrasil">${years.map(y=>`<option>${escapeHtml(y)}</option>`).join("")}</select>`);

    return;
  }

  if (v==="estados"){
    const est = await getData("estados");
    const estados = est.map(r=>String(r.estado||"").trim()).filter(Boolean);
    const years = Object.keys(est[0]||{}).filter(k=>/^\d{4}$/.test(k)).sort();

    addField(`<label>Estado</label>
      <select id="selEstado">${estados.map(s=>`<option>${escapeHtml(s)}</option>`).join("")}</select>`);

    addField(`<label>Ano (ranking)</label>
      <select id="selAnoRank">${years.map(y=>`<option>${y}</option>`).join("")}</select>`);

    addField(`<label>Top (ranking)</label>
      <select id="selTop">
        <option value="10">Top 10</option>
        <option value="20">Top 20</option>
        <option value="27">Top 27</option>
      </select>`);

    return;
  }

  if (v==="municipios"){
    addField(`<label>Digite o munic√≠pio (Regional de C√°ceres)</label>
      <input id="inpMun" placeholder="Ex: C√°ceres / Mirassol D‚ÄôOeste / Rio Branco‚Ä¶" />`);

    addField(`<label>&nbsp;</label>
      <button class="btn" id="btnBuscarMun">üîé Buscar</button>`);

    $("btnBuscarMun").addEventListener("click", async ()=>{
      const raw = ($("inpMun").value||"").trim();
      if (!raw) return alert("Digite um munic√≠pio.");
      state.selection.municipio = raw;
      await render();
    });

    return;
  }

  if (v==="sexo"){
    const sexo = await getData("sexo");
    const years = sexo.map(r=>String(r.anonotificao||r.anonotificacao||"").trim()).filter(Boolean);

    addField(`<label>Modo</label>
      <select id="selSexoModo">
        <option value="evolucao">Evolu√ß√£o anual</option>
        <option value="barras">Compara√ß√£o (ano)</option>
      </select>`);

    addField(`<label>Ano (para barras)</label>
      <select id="selSexoAno">${years.map(y=>`<option>${escapeHtml(y)}</option>`).join("")}</select>`);

    return;
  }

  if (v==="raca"){
    const raca = await getData("raca");
    const years = raca.map(r=>String(r.anonotificao||r.anonotificacao||"").trim()).filter(Boolean);

    addField(`<label>Modo</label>
      <select id="selRacaModo">
        <option value="evolucao">Evolu√ß√£o anual</option>
        <option value="barras">Compara√ß√£o (ano)</option>
      </select>`);

    addField(`<label>Ano (para barras)</label>
      <select id="selRacaAno">${years.map(y=>`<option>${escapeHtml(y)}</option>`).join("")}</select>`);

    return;
  }

  if (v==="faixa"){
    const fx = await getData("faixa");
    const labels = fx.map(r=>String(r.faixaetria||r.faixaetaria||"").trim()).filter(Boolean);

    addField(`<label>Faixa et√°ria</label>
      <select id="selFaixa">${labels.map(x=>`<option>${escapeHtml(x)}</option>`).join("")}</select>`);

    return;
  }

  if (v==="escolaridade"){
    const esc = await getData("escolaridade");
    const years = esc.map(r=>String(r.anonotificao||r.anonotificacao||"").trim()).filter(Boolean);

    addField(`<label>Modo</label>
      <select id="selEscModo">
        <option value="evolucao">Evolu√ß√£o anual</option>
        <option value="barras">Compara√ß√£o (ano)</option>
      </select>`);

    addField(`<label>Ano (para barras)</label>
      <select id="selEscAno">${years.map(y=>`<option>${escapeHtml(y)}</option>`).join("")}</select>`);

    return;
  }
}

/* =========================
   5) Render
   ========================= */
async function render(){
  destroyChart(state.charts.main);
  destroyChart(state.charts.alt);

  $("qaCards").innerHTML = "";
  $("metaTxt").textContent = "‚Äî";

  const v = state.view;
  const cMain = $("chartMain");
  const cAlt  = $("chartAlt");

  // KPIs default
  $("kpiSel").textContent = "‚Äî";
  $("kpiSelSub").textContent = "‚Äî";
  $("kpiPeak").textContent = "‚Äî";
  $("kpiPeakSub").textContent = "‚Äî";
  $("kpiTrend").textContent = "‚Äî";
  $("kpiTrendSub").textContent = "‚Äî";

  if (v==="brasil"){
    const brasil = await getData("brasil");
    $("rightTitle").textContent = "Brasil ‚Äî dengue";

    const modo = $("selBrasilModo")?.value || "anual";
    if (modo==="anual"){
      const series = brasil
        .map(r=>({x:String(r.ano||"").trim(), y:toNum(r.total)}))
        .filter(p=>p.x);

      state.charts.main = makeLineChart(
        cMain,
        series.map(p=>p.x),
        [{ label:"Brasil (Total)", data:series.map(p=>p.y) }],
        "Evolu√ß√£o anual"
      );

      const last = series.slice(-8);
      state.charts.alt = makeBarChart(
        cAlt,
        last.map(p=>p.x),
        "Total",
        last.map(p=>p.y),
        "√öltimos anos"
      );

      const pk = peak(series);
      const tr = trend(series);

      $("kpiSel").textContent = "Brasil (Total)";
      $("kpiSelSub").textContent = `${series[0]?.x || "‚Äî"} ‚Üí ${series.at(-1)?.x || "‚Äî"}`;
      $("kpiPeak").textContent = pk.x;
      $("kpiPeakSub").textContent = `${fmt(pk.y)} casos`;
      $("kpiTrend").textContent = tr.label;
      $("kpiTrendSub").textContent = tr.sub;

      addQA("Qual foi o pior ano no Brasil?", `Pico em ${pk.x} com ${fmt(pk.y)} casos.`);
      addQA("A dengue subiu recentemente?", `Tend√™ncia: ${tr.label}. ${tr.sub}.`);
      $("metaTxt").textContent = "Carrega s√≥ o Brasil primeiro (r√°pido).";
    } else {
      const ano = $("selAnoBrasil")?.value || String(brasil.at(-1)?.ano||"");
      const row = brasil.find(r=>String(r.ano).trim()===String(ano));
      const series = MONTHS.map(m=>({x:m, y: toNum(row?.[normKey(m)]) || toNum(row?.[m]) }));

      state.charts.main = makeLineChart(
        cMain,
        series.map(p=>p.x),
        [{ label:`Brasil (Mensal ${ano})`, data: series.map(p=>p.y) }],
        `Sazonalidade ‚Äî ${ano}`
      );
      state.charts.alt = makeBarChart(
        cAlt,
        series.map(p=>p.x),
        `Mensal ${ano}`,
        series.map(p=>p.y),
        "Distribui√ß√£o mensal"
      );

      const pk = peak(series);
      $("kpiSel").textContent = `Brasil (Mensal ${ano})`;
      $("kpiSelSub").textContent = "Sazonalidade";
      $("kpiPeak").textContent = pk.x;
      $("kpiPeakSub").textContent = `${fmt(pk.y)} casos`;
      addQA(`Qual m√™s foi o pico em ${ano}?`, `Pico em ${pk.x} com ${fmt(pk.y)} casos.`);
      $("metaTxt").textContent = "Mensal por ano (leve).";
    }

    return;
  }

  if (v==="estados"){
    const est = await getData("estados");
    const uf = $("selEstado")?.value || String(est[0]?.estado||"");
    $("rightTitle").textContent = `Estado ‚Äî ${uf}`;

    const row = est.find(r=>String(r.estado||"").trim().toLowerCase()===uf.trim().toLowerCase()) || est[0];
    const years = Object.keys(row||{}).filter(k=>/^\d{4}$/.test(k)).sort();
    const series = years.map(y=>({x:y, y:toNum(row?.[y])}));

    state.charts.main = makeLineChart(
      cMain,
      series.map(p=>p.x),
      [{ label:uf, data:series.map(p=>p.y) }],
      "Evolu√ß√£o anual (Estado)"
    );

    const anoRank = $("selAnoRank")?.value || years.at(-1);
    const topN = parseInt($("selTop")?.value||"10",10);

    const top = est
      .map(r=>({k:String(r.estado||"").trim(), v:toNum(r[anoRank])}))
      .filter(x=>x.k)
      .sort((a,b)=>b.v-a.v)
      .slice(0, topN);

    state.charts.alt = makeBarChart(
      cAlt,
      top.map(x=>x.k),
      `Total (${anoRank})`,
      top.map(x=>x.v),
      `Ranking ‚Äî Top ${topN}`
    );

    const pk = peak(series);
    const tr = trend(series);

    $("kpiSel").textContent = `Estado: ${uf}`;
    $("kpiSelSub").textContent = `${years[0]} ‚Üí ${years.at(-1)}`;
    $("kpiPeak").textContent = pk.x;
    $("kpiPeakSub").textContent = `${fmt(pk.y)} casos`;
    $("kpiTrend").textContent = tr.label;
    $("kpiTrendSub").textContent = tr.sub;

    addQA("Esse estado subiu recentemente?", `Tend√™ncia: ${tr.label}. ${tr.sub}.`);
    addQA("Pior ano do estado", `Pico em ${pk.x} com ${fmt(pk.y)} casos.`);
    $("metaTxt").textContent = "Carrega s√≥ o CSV de estados nessa aba.";
    return;
  }

  if (v==="municipios"){
    const mun = await getData("municipios");
    $("rightTitle").textContent = "Munic√≠pios ‚Äî Regional de C√°ceres";

    const query = (state.selection.municipio || "").trim();
    if (!query){
      $("metaTxt").textContent = "Digite um munic√≠pio e clique Buscar.";
      addQA("Como usar?", "Digite e clique Buscar. S√≥ 12 munic√≠pios (leve).");
      return;
    }

    // no seu DataSUS costuma vir como "municpio"
    const key = "municpio";
    const qn = normKey(query);

    const row =
      mun.find(r=> normKey(r[key]||"") === qn) ||
      mun.find(r=> normKey(r[key]||"").includes(qn)) ||
      mun.find(r=> normKey(r[key]||"").startsWith(qn));

    if (!row){
      $("metaTxt").textContent = `N√£o encontrei "${query}" na Regional de C√°ceres.`;
      addQA("Dica", "Tente sem acento (ex: 'caceres', 'mirassol', 'rio branco').");
      return;
    }

    const name = String(row[key]||query).trim();
    const years = Object.keys(row).filter(k=>/^\d{4}$/.test(k)).sort();
    const series = years.map(y=>({x:y, y:toNum(row[y])}));

    state.charts.main = makeLineChart(
      cMain,
      series.map(p=>p.x),
      [{ label:name, data:series.map(p=>p.y) }],
      "Evolu√ß√£o anual (Munic√≠pio)"
    );

    const last = series.slice(-10);
    state.charts.alt = makeBarChart(
      cAlt,
      last.map(p=>p.x),
      "Total",
      last.map(p=>p.y),
      "√öltimos 10 anos"
    );

    const pk = peak(series);
    const tr = trend(series);

    $("kpiSel").textContent = name;
    $("kpiSelSub").textContent = `${years[0]} ‚Üí ${years.at(-1)}`;
    $("kpiPeak").textContent = pk.x;
    $("kpiPeakSub").textContent = `${fmt(pk.y)} casos`;
    $("kpiTrend").textContent = tr.label;
    $("kpiTrendSub").textContent = tr.sub;

    addQA("O munic√≠pio piorou recentemente?", `Tend√™ncia: ${tr.label}. ${tr.sub}.`);
    addQA("Pior ano do munic√≠pio", `Pico em ${pk.x} com ${fmt(pk.y)} casos.`);
    $("metaTxt").textContent = "Munic√≠pios leves (12 da regional).";
    return;
  }

  if (v==="sexo"){
    const sexo = await getData("sexo");
    $("rightTitle").textContent = "Sexo ‚Äî compara√ß√µes";

    const modo = $("selSexoModo")?.value || "evolucao";
    const years = sexo.map(r=>String(r.anonotificao||r.anonotificacao||"").trim()).filter(Boolean);
    const masc = sexo.map(r=>toNum(r.masculino));
    const fem  = sexo.map(r=>toNum(r.feminino));
    const ign  = sexo.map(r=>toNum(r.ignorado));

    if (modo==="evolucao"){
      state.charts.main = makeLineChart(
        cMain,
        years,
        [
          { label:"Masculino", data: masc },
          { label:"Feminino",  data: fem  },
          { label:"Ignorado",  data: ign  },
        ],
        "Evolu√ß√£o anual por sexo"
      );
      const i = years.length-1;
      state.charts.alt = makeBarChart(
        cAlt,
        ["Masculino","Feminino","Ignorado"],
        `Total (${years[i]})`,
        [masc[i], fem[i], ign[i]],
        "√öltimo ano"
      );
    } else {
      const ano = $("selSexoAno")?.value || years.at(-1);
      const idx = years.indexOf(ano);
      state.charts.main = makeBarChart(
        cMain,
        ["Masculino","Feminino","Ignorado"],
        `Total (${ano})`,
        [masc[idx], fem[idx], ign[idx]],
        "Compara√ß√£o por sexo"
      );
      const total = years.map((_,i)=>toNum(masc[i])+toNum(fem[i]));
      state.charts.alt = makeLineChart(
        cAlt,
        years,
        [{label:"Masculino+Feminino", data: total}],
        "Evolu√ß√£o (M+F)"
      );
    }

    addQA("Quem tem mais casos no √∫ltimo ano?", `Masculino: ${fmt(masc.at(-1))} ‚Ä¢ Feminino: ${fmt(fem.at(-1))}.`);
    $("metaTxt").textContent = "Carrega s√≥ quando abre essa aba.";
    return;
  }

  if (v==="raca"){
    const raca = await getData("raca");
    $("rightTitle").textContent = "Ra√ßa/Cor ‚Äî compara√ß√µes";

    const modo = $("selRacaModo")?.value || "evolucao";
    const years = raca.map(r=>String(r.anonotificao||r.anonotificacao||"").trim()).filter(Boolean);

    const cols = ["branca","preta","amarela","parda","indigena"];
    const values = Object.fromEntries(cols.map(c=>[c, raca.map(r=>toNum(r[c]))]));

    if (modo==="evolucao"){
      const ds = cols.map(c=>({ label:c, data: values[c] }));
      state.charts.main = makeLineChart(cMain, years, ds, "Evolu√ß√£o anual por ra√ßa/cor");
      const i = years.length-1;
      state.charts.alt = makeBarChart(cAlt, cols, `Total (${years[i]})`, cols.map(c=>values[c][i]), "√öltimo ano");
    } else {
      const ano = $("selRacaAno")?.value || years.at(-1);
      const idx = years.indexOf(ano);
      state.charts.main = makeBarChart(cMain, cols, `Total (${ano})`, cols.map(c=>values[c][idx]), "Compara√ß√£o");
      const total = years.map((_,i)=>cols.reduce((s,c)=>s+toNum(values[c][i]),0));
      state.charts.alt = makeLineChart(cAlt, years, [{label:"Total (soma)", data: total}], "Total");
    }

    const i = years.length-1;
    const arr = cols.map(c=>({c, v:values[c][i]})).sort((a,b)=>b.v-a.v);
    addQA("Quem lidera no √∫ltimo ano?", `${arr[0].c} (${fmt(arr[0].v)})`);
    $("metaTxt").textContent = "Carrega s√≥ quando abre essa aba.";
    return;
  }

  if (v==="faixa"){
    const fx = await getData("faixa");
    $("rightTitle").textContent = "Faixa et√°ria ‚Äî total";

    const labels = fx.map(r=>String(r.faixaetria||r.faixaetaria||"").trim()).filter(Boolean);
    const vals = fx.map(r=>toNum(r.total));

    const arr = labels.map((l,i)=>({l,v:vals[i]})).sort((a,b)=>b.v-a.v).slice(0,15);
    state.charts.main = makeBarChart(cMain, arr.map(x=>x.l), "Total", arr.map(x=>x.v), "Top faixas (total)");
    addQA("Importante", "Sem taxa por popula√ß√£o, isso √© distribui√ß√£o de casos, n√£o risco.");
    $("metaTxt").textContent = "Carrega s√≥ quando abre essa aba.";
    return;
  }

  if (v==="escolaridade"){
    const esc = await getData("escolaridade");
    $("rightTitle").textContent = "Escolaridade ‚Äî compara√ß√µes";

    const modo = $("selEscModo")?.value || "evolucao";
    const years = esc.map(r=>String(r.anonotificao||r.anonotificacao||"").trim()).filter(Boolean);
    const keys = Object.keys(esc[0]||{}).filter(k=>!["anonotificao","anonotificacao","total"].includes(k));
    const totals = keys.map(k=>({k, t: esc.reduce((s,r)=>s+toNum(r[k]),0)})).sort((a,b)=>b.t-a.t);

    if (modo==="evolucao"){
      const keep = totals.slice(0,6).map(x=>x.k);
      const ds = keep.map(k=>({label:k, data: esc.map(r=>toNum(r[k]))}));
      state.charts.main = makeLineChart(cMain, years, ds, "Top 6 escolaridades (evolu√ß√£o)");

      const i = years.length-1;
      const top8 = totals.slice(0,8).map(x=>x.k);
      state.charts.alt = makeBarChart(cAlt, top8, `Total (${years[i]})`, top8.map(k=>toNum(esc[i][k])), "√öltimo ano (Top 8)");
    } else {
      const ano = $("selEscAno")?.value || years.at(-1);
      const idx = years.indexOf(ano);
      const top12 = totals
        .map(x=>({k:x.k, v: toNum(esc[idx][x.k])}))
        .sort((a,b)=>b.v-a.v)
        .slice(0,12);

      state.charts.main = makeBarChart(cMain, top12.map(x=>x.k), `Total (${ano})`, top12.map(x=>x.v), "Compara√ß√£o por escolaridade");

      const top2 = top12.slice(0,2).map(x=>x.k);
      const ds = top2.map(k=>({label:k, data: esc.map(r=>toNum(r[k]))}));
      state.charts.alt = makeLineChart(cAlt, years, ds, "Evolu√ß√£o das 2 maiores");
    }

    addQA("Leitura", "Isso mostra concentra√ß√£o por escolaridade registrada. Para risco, precisa taxa por popula√ß√£o.");
    $("metaTxt").textContent = "Carrega s√≥ quando abre essa aba.";
    return;
  }
}

/* =========================
   6) eventos
   ========================= */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", async ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("active", x===t));
    state.view = t.dataset.view;
    await buildControls();
    await render();
  });
});

$("btnReload").addEventListener("click", async ()=>{
  state.cache = {};
  await buildControls();
  await render();
});

$("btnApply").addEventListener("click", render);

$("btnDownload").addEventListener("click", ()=>{
  alert("Export simples pode ser ligado depois. Primeiro vamos garantir tudo rodando.");
});

/* =========================
   start
   ========================= */
(async ()=>{
  try{
    setStatus(false, "Carregando Brasil‚Ä¶");
    await buildControls();
    await render();
    setStatus(true, "Pronto ‚úÖ");
  }catch(err){
    console.error(err);
    setStatus(false, "Erro ao iniciar (abra o Console/F12).");
    alert("Deu erro no JS. Abra o Console (F12) e veja a mensagem. Se quiser, me mande o print do Console.");
  }
})();
</script>
</body>
</html>
